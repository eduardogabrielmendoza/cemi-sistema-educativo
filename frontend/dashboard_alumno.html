<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1e1e1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="images/logo.png">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Panel del Alumno - CEMI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/dashboard.css" />
  <link rel="stylesheet" href="assets/css/dashboard_alumno_extras.css" />
  <link rel="stylesheet" href="assets/css/credit-card.css" />
  <link rel="stylesheet" href="assets/css/user-chat-manager.css" />
  <link rel="stylesheet" href="assets/css/cursado.css" />
  <link rel="stylesheet" href="assets/css/ayuda-section.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <!-- Verificaci√≥n de mantenimiento del sistema -->
  <script src="assets/js/config.js?v=1.1"></script>
  <script src="assets/js/check-maintenance.js"></script>
  
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="dashboard-body">

  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i data-lucide="menu"></i>
  </button>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="images/logo.png" alt="Logo CEMI">
      <h2>CEMI</h2>
    </div>
    <nav class="sidebar-menu">
      <button id="btnCursos"><i data-lucide="book-open"></i> Mis Cursos</button>
      <button id="btnCursado"><i data-lucide="graduation-cap"></i> Cursado</button>
      <button id="btnNotas"><i data-lucide="clipboard-list"></i> Mis Calificaciones</button>
      <button id="btnPagos"><i data-lucide="credit-card"></i> Mis Pagos</button>
      <button id="btnPerfil"><i data-lucide="user"></i> Mi Perfil</button>
      <button id="btnClassroom" onclick="window.location.href='classroom.html'"><i data-lucide="school"></i> Classroom</button>
      <button id="btnChatSoporte" style="position: relative;">
        <i data-lucide="message-circle"></i> Chat Soporte
        <span id="chatNotificationBadge" class="notification-badge" style="display: none;"></span>
      </button>
      <button id="btnAyuda"><i data-lucide="help-circle"></i> Ayuda</button>
      <button id="logoutBtn" class="logout"><i data-lucide="log-out"></i> Cerrar sesi√≥n</button>
    </nav>
  </aside>

  <main class="dashboard-main">
    <header class="dashboard-header">
      <h1>Panel del Alumno</h1>
      <div class="user-info">
        <div class="user-avatar-header" id="userAvatarHeader">
          <i data-lucide="user"></i>
        </div>
        <span id="welcomeMessage">Alumno</span>
      </div>
    </header>

    <div id="loader" class="loader hidden"></div>

    <section id="mainContent" class="dashboard-content spa-animate active"></section>
  </main>

  <script>
  // VERSION: TICKET EFECTIVO v3.0 - 2025-11-14 04:09
  console.log('%c DASHBOARD ALUMNO - VERSION TICKET EFECTIVO v3.0', 'background: #1e3c72; color: white; padding: 10px; font-size: 16px; font-weight: bold;');
  console.log(' Script cargado correctamente');
  
  lucide.createIcons();

  const API_URL = window.API_URL || "http://localhost:3000/api";
  const loader = document.getElementById("loader");
  const mainContent = document.getElementById("mainContent");
  const welcomeMessage = document.getElementById("welcomeMessage");
  const id_alumno = localStorage.getItem("id_alumno");
  
  if (!id_alumno) {
    console.error("No se encontr√≥ el ID del alumno");
    window.location.href = "login.html";
  }

  // Cargar Socket.IO primero
  const socketScript = document.createElement('script');
  socketScript.src = 'https://cdn.socket.io/4.7.2/socket.io.min.js';
  socketScript.onload = () => {
    // Luego cargar script del chat y crear instancia
    const chatScript = document.createElement('script');
    chatScript.src = `assets/js/user-chat-manager.js?v=${Date.now()}`; // Cache busting
    chatScript.onload = () => {
      console.log(' user-chat-manager.js cargado correctamente');
      if (typeof UserChatManager !== 'undefined') {
        window.userChatManager = new UserChatManager('alumno');
        // Inicializar Socket.IO inmediatamente para recibir notificaciones
        window.userChatManager.init();
      } else {
        console.error(' UserChatManager no est√° definido');
      }
    };
    chatScript.onerror = () => {
      console.error(' Error al cargar user-chat-manager.js');
    };
    document.head.appendChild(chatScript);
  };
  document.head.appendChild(socketScript);

  // Mostrar saludo din√°mico con nombre guardado
  const nombreAlumno = localStorage.getItem("nombre") || "Alumno";
  welcomeMessage.textContent = `Bienvenido/a, ${nombreAlumno} `;

  // Cargar avatar del usuario
  async function cargarAvatarHeader() {
    try {
      console.log('üé® Iniciando carga de avatar...');
      
      // Detectar tipo de usuario seg√∫n qu√© ID existe en localStorage
      let tipoUsuario = 'alumno';
      let idUsuario = localStorage.getItem('id_alumno');
      
      console.log('üìã id_alumno:', idUsuario);
      
      if (!idUsuario) {
        idUsuario = localStorage.getItem('id_profesor');
        if (idUsuario) {
          tipoUsuario = 'profesor';
        }
      }
      
      if (!idUsuario) {
        console.log('‚ùå No se encontr√≥ ID de usuario');
        return;
      }
      
      console.log(`Buscando perfil de ${tipoUsuario} con ID: ${idUsuario}`);
      
      const url = `${API_URL}/classroom/perfil/${idUsuario}?tipo=${tipoUsuario}`;
      console.log('URL:', url);
      
      const response = await fetch(url);
      const data = await response.json();
      
      console.log('Respuesta del servidor:', { status: response.status, data });
      
      if (response.ok && data.success && data.perfil) {
        const avatarContainer = document.getElementById('userAvatarHeader');
        console.log('Contenedor encontrado:', !!avatarContainer);
        
        if (avatarContainer && data.perfil.avatar) {
          const BASE_URL = window.BASE_URL || 'http://localhost:3000';
          const avatarUrl = data.perfil.avatar.startsWith('http') 
            ? data.perfil.avatar 
            : `${BASE_URL}${data.perfil.avatar}?t=${Date.now()}`;
          console.log('Cargando avatar:', avatarUrl);
          
          const img = new Image();
          img.onload = function() {
            avatarContainer.innerHTML = `<img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
          };
          img.onerror = function() {
            console.log('Avatar no disponible, usando icono');
            avatarContainer.innerHTML = '<i data-lucide="user"></i>';
            lucide.createIcons();
          };
          img.src = avatarUrl;
        } else {
          console.log('Sin avatar, usando icono');
          if (avatarContainer) {
            avatarContainer.innerHTML = '<i data-lucide="user"></i>';
            lucide.createIcons();
          }
        }
      } else {
        console.log('Respuesta no valida o usuario no encontrado');
      }
    } catch (error) {
      console.error('üí• Error al cargar avatar:', error);
    }
  }
  
  cargarAvatarHeader();

  const sections = {
    btnCursos: async () => {
      loader.classList.remove("hidden");
      mainContent.classList.remove("active");
      
      console.log("ID Alumno:", id_alumno); // Debug
      
      try {
        const response = await fetch(`${API_URL}/alumnos/${id_alumno}`);
        
        console.log("Response status:", response.status); // Debug
        
        if (!response.ok) {
          throw new Error(`Error al cargar los datos del alumno: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log("Datos recibidos:", data); // Debug

        const cursos = data.cursos || [];
        const totalCursos = cursos.length;
        const promedioGeneral = parseFloat(data.promedio_general) || 0;

        mainContent.innerHTML = `
          <div style="padding: 20px;">
            <!-- Header -->
            <div style="margin-bottom: 24px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <i data-lucide="book-open" style="width: 28px; height: 28px; color: #4a5259;"></i>
                <h2 style="margin: 0; color: #1e1e1e; font-size: 24px; font-weight: 500; font-family: 'Inter', sans-serif;">Mis Cursos</h2>
              </div>
              <p style="margin: 0; color: #6b7280; font-size: 14px;">Gestiona tus cursos inscritos y visualiza tu progreso</p>
            </div>

            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px;">
              <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 16px;">
                <div style="background: rgba(74, 82, 89, 0.08); border-radius: 12px; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;">
                  <i data-lucide="book-open" style="width: 28px; height: 28px; color: #4a5259;"></i>
                </div>
                <div>
                  <div style="font-size: 32px; font-weight: 600; color: #1e1e1e;">${totalCursos}</div>
                  <div style="font-size: 14px; color: #6b7280; font-weight: 500;">Cursos Inscritos</div>
                </div>
              </div>

              <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 16px;">
                <div style="background: rgba(74, 82, 89, 0.08); border-radius: 12px; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;">
                  <i data-lucide="trending-up" style="width: 28px; height: 28px; color: #4a5259;"></i>
                </div>
                <div>
                  <div style="font-size: 32px; font-weight: 600; color: #1e1e1e;">${promedioGeneral > 0 ? promedioGeneral.toFixed(1) : 'S/N'}</div>
                  <div style="font-size: 14px; color: #6b7280; font-weight: 500;">Promedio General</div>
                </div>
              </div>

              <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 16px;">
                <div style="background: rgba(74, 82, 89, 0.08); border-radius: 12px; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;">
                  <i data-lucide="award" style="width: 28px; height: 28px; color: #4a5259;"></i>
                </div>
                <div>
                  <div style="font-size: 32px; font-weight: 600; color: #1e1e1e;">${cursos.filter(c => c.promedio && c.promedio >= 7).length}/${totalCursos}</div>
                  <div style="font-size: 14px; color: #6b7280; font-weight: 500;">Aprobados</div>
                </div>
              </div>
            </div>

            <!-- Cursos Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px;">
              ${cursos.length > 0 ? cursos.map((curso, index) => {
                const promedio = parseFloat(curso.promedio) || 0;
                const progreso = promedio > 0 ? Math.min((promedio / 10) * 100, 100) : 0;
                let barColor = '#4a5259';
                if (promedio >= 7) barColor = '#22c55e';
                else if (promedio >= 5) barColor = '#f59e0b';
                else if (promedio > 0) barColor = '#ef4444';
                
                return `
                <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s ease;" onclick="abrirDetalleCursoAlumno(${curso.id_curso}, '${curso.nombre_curso}')" onmouseenter="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.12)'; this.style.transform='translateY(-2px)';" onmouseleave="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'; this.style.transform='translateY(0)';">
                  
                  <div style="position: absolute; top: 12px; right: 12px; background: rgba(74, 82, 89, 0.1); color: #4a5259; font-size: 11px; font-weight: 500; padding: 4px 10px; border-radius: 12px;">Nivel ${curso.id_nivel || 'N/A'}</div>
                  
                  <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
                    <div style="background: rgba(74, 82, 89, 0.08); border-radius: 12px; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                      <i data-lucide="book-open" style="width: 28px; height: 28px; color: #4a5259;"></i>
                    </div>
                    <div style="flex: 1; min-width: 0; padding-right: 70px;">
                      <h3 style="margin: 0 0 4px 0; color: #1e1e1e; font-size: 16px; font-weight: 500; font-family: 'Inter', sans-serif;">${curso.nombre_curso}</h3>
                      <p style="margin: 0; color: #6b7280; font-size: 13px;">${curso.nombre_idioma || 'Curso'}</p>
                    </div>
                  </div>
                  
                  <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: #6b7280; font-size: 13px;">
                      <i data-lucide="clock" style="width: 14px; height: 14px; color: #9ca3af;"></i>
                      <span>${curso.horario || 'Por confirmar'}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; color: #6b7280; font-size: 13px;">
                      <i data-lucide="trending-up" style="width: 14px; height: 14px; color: #9ca3af;"></i>
                      <span>Promedio: <strong style="color: ${promedio >= 7 ? '#22c55e' : promedio >= 5 ? '#f59e0b' : promedio > 0 ? '#ef4444' : '#6b7280'}">${promedio > 0 ? promedio.toFixed(1) : 'S/N'}</strong></span>
                    </div>
                  </div>
                  
                  ${promedio > 0 ? `
                  <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                      <span style="color: #6b7280; font-size: 12px;">Progreso</span>
                      <span style="color: #1e1e1e; font-size: 12px; font-weight: 500;">${progreso.toFixed(0)}%</span>
                    </div>
                    <div style="height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                      <div style="height: 100%; width: ${progreso}%; background: ${barColor}; border-radius: 3px; transition: width 0.3s ease;"></div>
                    </div>
                  </div>
                  ` : `
                  <div style="padding: 12px; background: rgba(74, 82, 89, 0.05); border-radius: 8px; margin-bottom: 16px;">
                    <span style="color: #6b7280; font-size: 13px;">Sin calificaciones registradas</span>
                  </div>
                  `}
                  
                  <div style="height: 1px; background: #e5e7eb; margin: 16px 0;"></div>
                  
                  <div style="display: flex; justify-content: flex-end;">
                    <button style="background: rgba(74, 82, 89, 0.08); border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; color: #4a5259; font-size: 13px; font-weight: 500; transition: all 0.2s;" onclick="event.stopPropagation(); abrirDetalleCursoAlumno(${curso.id_curso}, '${curso.nombre_curso}')" onmouseenter="this.style.background='rgba(74, 82, 89, 0.15)'" onmouseleave="this.style.background='rgba(74, 82, 89, 0.08)'">
                      <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                      Ver detalles
                    </button>
                  </div>
                </div>
              `}).join('') : `
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: white; border-radius: 16px; border: 2px dashed #e5e7eb;">
                  <div style="background: rgba(74, 82, 89, 0.08); border-radius: 50%; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <i data-lucide="inbox" style="width: 40px; height: 40px; color: #9ca3af;"></i>
                  </div>
                  <h3 style="margin: 0 0 8px 0; color: #1e1e1e; font-size: 18px; font-weight: 500;">No hay cursos inscritos</h3>
                  <p style="margin: 0; color: #6b7280; font-size: 14px;">A√∫n no est√°s inscrito en ning√∫n curso. Contacta con administraci√≥n para m√°s informaci√≥n.</p>
                </div>
              `}
            </div>
          </div>
        `;

        lucide.createIcons();
        loader.classList.add("hidden");
        setTimeout(() => mainContent.classList.add("active"), 100);

      } catch (error) {
        console.error("Error al cargar cursos:", error);
        mainContent.innerHTML = `
          <div class="error-container">
            <i data-lucide="alert-circle"></i>
            <h3>Error al cargar los cursos</h3>
            <p>Por favor, intenta nuevamente m√°s tarde.</p>
          </div>
        `;
        lucide.createIcons();
        loader.classList.add("hidden");
        setTimeout(() => mainContent.classList.add("active"), 100);
      }
    },

    btnCursado: async () => {
      loader.classList.remove("hidden");
      mainContent.classList.remove("active");

      try {
        mainContent.innerHTML = `
          <div id="cursado-section" class="cursado-container">
            <div class="section-header-alumno">
              <div class="header-title">
                <i data-lucide="graduation-cap"></i>
                <h2>Cat√°logo de Cursos</h2>
              </div>
              <p class="section-subtitle">Explora todos los cursos disponibles y solicita tu inscripci√≥n</p>
            </div>

            <div class="mis-cursos-actuales-mini">
              <h3><i data-lucide="book-open"></i> Mis Cursos Actuales</h3>
              <div id="mis-cursos-container" class="mis-cursos-mini-grid">
                <div class="loading-container">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p>Cargando...</p>
                </div>
              </div>
            </div>

            <hr class="section-divider">

            <div class="filtros-section">
              <h3><i data-lucide="search"></i> Buscar Cursos</h3>
              <div class="filtros-grid">
                <div class="form-group" style="grid-column: 1 / -1;">
                  <input 
                    type="text" 
                    id="busqueda-curso" 
                    class="form-control" 
                    placeholder="Buscar por nombre de curso, idioma o profesor..."
                    style="font-size: 1rem; padding: 12px 16px;">
                </div>
              </div>
            </div>

            <div class="resultados-header">
              <h3><i data-lucide="book"></i> Cursos Disponibles</h3>
              <span id="total-cursos-count" class="resultados-count">Cargando...</span>
            </div>

            <div id="catalogo-cursos-container" class="catalogo-cursos-grid">
              <div class="loading-container">
                <div class="spinner-border text-primary" role="status"></div>
                <p>Cargando cat√°logo de cursos...</p>
              </div>
            </div>
          </div>
        `;

        lucide.createIcons();
        loader.classList.add("hidden");
        setTimeout(() => mainContent.classList.add("active"), 100);

        // Cargar/Reinicializar el manager (evitar duplicados)
        if (!window.cursadoManagerLoaded) {
          const script = document.createElement('script');
          script.src = `assets/js/cursado-manager.js?v=${Date.now()}`;
          script.onload = () => {
            console.log(' cursado-manager.js cargado correctamente');
            window.cursadoManagerLoaded = true;
          };
          script.onerror = () => {
            console.error(' Error al cargar cursado-manager.js');
            mainContent.innerHTML = `
              <div class="error-container">
                <i data-lucide="alert-circle"></i>
                <h3>Error al cargar la secci√≥n</h3>
                <p>No se pudo cargar el m√≥dulo de cursado. Por favor, recarga la p√°gina.</p>
              </div>
            `;
            lucide.createIcons();
          };
          document.head.appendChild(script);
        } else if (window.cursadoManager) {
          // Si ya est√° cargado, reinicializar
          window.cursadoManager.init();
        }

      } catch (error) {
        console.error("Error al cargar secci√≥n Cursado:", error);
        mainContent.innerHTML = `
          <div class="error-container">
            <i data-lucide="alert-circle"></i>
            <h3>Error al cargar el cat√°logo</h3>
            <p>Por favor, intenta nuevamente m√°s tarde.</p>
          </div>
        `;
        lucide.createIcons();
        loader.classList.add("hidden");
        setTimeout(() => mainContent.classList.add("active"), 100);
      }
    },

    btnNotas: async () => {
      loader.classList.remove("hidden");
      mainContent.classList.remove("active");

      try {
        const response = await fetch(`${API_URL}/alumnos/${id_alumno}`);
        
        if (!response.ok) {
          throw new Error(`Error al cargar calificaciones: ${response.status}`);
        }
        
        const data = await response.json();
        const cursos = data.cursos || [];

        mainContent.innerHTML = `
          <div class="alumno-calificaciones-container">
            <div class="section-header-alumno">
              <div class="header-title">
                <i data-lucide="clipboard-list"></i>
                <h2>Mis Calificaciones</h2>
              </div>
            </div>

            <div class="calificaciones-resumen">
              <div class="resumen-card">
                <div class="resumen-icon" style="background: rgba(74, 82, 89, 0.08);">
                  <i data-lucide="book-open" style="color: #4a5259;"></i>
                </div>
                <div class="resumen-info">
                  <h3>${cursos.length}</h3>
                  <p>Cursos Activos</p>
                </div>
              </div>

              <div class="resumen-card">
                <div class="resumen-icon" style="background: rgba(74, 82, 89, 0.08);">
                  <i data-lucide="bar-chart-3" style="color: #4a5259;"></i>
                </div>
                <div class="resumen-info">
                  <h3>${parseFloat(data.promedio_general) > 0 ? parseFloat(data.promedio_general).toFixed(1) : 'S/N'}</h3>
                  <p>Promedio General</p>
                </div>
              </div>

              <div class="resumen-card">
                <div class="resumen-icon" style="background: rgba(74, 82, 89, 0.08);">
                  <i data-lucide="trending-up" style="color: #4a5259;"></i>
                </div>
                <div class="resumen-info">
                  <h3>${cursos.filter(c => c.promedio && c.promedio >= 7).length}</h3>
                  <p>Cursos Aprobados</p>
                </div>
              </div>
            </div>

            <div class="calificaciones-tabla-container">
              <h3><i data-lucide="list"></i> Detalle de Calificaciones</h3>
              
              ${cursos.length > 0 ? `
                <div class="tabla-calificaciones-wrapper">
                  <table class="tabla-calificaciones-alumno">
                    <thead>
                      <tr>
                        <th>Curso</th>
                        <th>Idioma</th>
                        <th>Parcial 1</th>
                        <th>Parcial 2</th>
                        <th>Final</th>
                        <th>Promedio</th>
                        <th>Estado</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${cursos.map(curso => {
                        const promedio = parseFloat(curso.promedio) || 0;
                        let estadoClase = 'estado-pendiente';
                        let estadoTexto = 'Pendiente';
                        
                        if (promedio >= 7) {
                          estadoClase = 'estado-aprobado';
                          estadoTexto = 'Aprobado';
                        } else if (promedio >= 4) {
                          estadoClase = 'estado-regular';
                          estadoTexto = 'Regular';
                        } else if (promedio > 0) {
                          estadoClase = 'estado-reprobado';
                          estadoTexto = 'Reprobado';
                        }

                        return `
                          <tr onclick="verDetalleCalificacion(${curso.id_curso}, '${curso.nombre_curso}')">
                            <td class="curso-nombre">
                              <i data-lucide="book"></i>
                              <span>${curso.nombre_curso}</span>
                            </td>
                            <td>${curso.nombre_idioma || 'N/A'}</td>
                            <td class="nota-valor">${curso.parcial1 || '-'}</td>
                            <td class="nota-valor">${curso.parcial2 || '-'}</td>
                            <td class="nota-valor">${curso.final || '-'}</td>
                            <td class="promedio-valor ${promedio >= 7 ? 'aprobado' : promedio >= 4 ? 'regular' : promedio > 0 ? 'desaprobado' : ''}">
                              ${promedio > 0 ? promedio.toFixed(1) : '-'}
                            </td>
                            <td>
                              <span class="estado-badge ${estadoClase}">
                                ${estadoTexto}
                              </span>
                            </td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
                
                <div class="leyenda-calificaciones">
                  <h4><i data-lucide="info"></i> Escala de Calificaciones</h4>
                  <div class="leyenda-items">
                    <div class="leyenda-item">
                      <span class="leyenda-dot" style="background: #43a047;"></span>
                      <span>Aprobado: 7.0 - 10.0</span>
                    </div>
                    <div class="leyenda-item">
                      <span class="leyenda-dot" style="background: #fb8c00;"></span>
                      <span>Regular: 4.0 - 6.9</span>
                    </div>
                    <div class="leyenda-item">
                      <span class="leyenda-dot" style="background: #e53935;"></span>
                      <span>Reprobado: 0.0 - 3.9</span>
                    </div>
                  </div>
                </div>
              ` : `
                <div class="empty-state-calificaciones">
                  <i data-lucide="clipboard-x"></i>
                  <h3>No hay calificaciones disponibles</h3>
                  <p>A√∫n no tienes cursos con calificaciones registradas.</p>
                </div>
              `}
            </div>
          </div>
        `;

        lucide.createIcons();
        loader.classList.add("hidden");
        setTimeout(() => mainContent.classList.add("active"), 100);

      } catch (error) {
        console.error("Error al cargar calificaciones:", error);
        mainContent.innerHTML = `
          <div class="error-container">
            <i data-lucide="alert-circle"></i>
            <h3>Error al cargar las calificaciones</h3>
            <p>Por favor, intenta nuevamente m√°s tarde.</p>
          </div>
        `;
        lucide.createIcons();
        loader.classList.add("hidden");
        setTimeout(() => mainContent.classList.add("active"), 100);
      }
    },

    btnPagos: async () => {
      loader.classList.remove("hidden");
      mainContent.classList.remove("active");

      try {
        const response = await fetch(`${API_URL}/pagos/alumno/${id_alumno}`);
        
        if (!response.ok) {
          throw new Error(`Error al cargar pagos: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Datos de pagos por curso:", data);

        const cursos = data.cursos || [];
        const estadisticas = data.estadisticas_globales || {
          total_pagado: 0,
          total_pendiente: 0,
          total_cursos: 0,
          cuotas_vencidas: 0
        };

        mainContent.innerHTML = `
          <div class="alumno-pagos-container">
            <div class="section-header-alumno">
              <div class="header-title">
                <i data-lucide="credit-card"></i>
                <h2>Mis Pagos</h2>
              </div>
              <p class="section-subtitle">Gestiona los pagos de tus cursos activos</p>
            </div>

            <div class="pagos-stats-grid">
              <div class="stat-pago-card total-pagado">
                <div class="stat-pago-icon">
                  <i data-lucide="check-circle"></i>
                </div>
                <div class="stat-pago-info">
                  <p>Total Pagado</p>
                  <h3>$${estadisticas.total_pagado.toLocaleString('es-AR', {minimumFractionDigits: 2})}</h3>
                </div>
              </div>

              <div class="stat-pago-card total-pendiente">
                <div class="stat-pago-icon">
                  <i data-lucide="clock"></i>
                </div>
                <div class="stat-pago-info">
                  <p>Total Pendiente</p>
                  <h3>$${estadisticas.total_pendiente.toLocaleString('es-AR', {minimumFractionDigits: 2})}</h3>
                </div>
              </div>

              <div class="stat-pago-card cuotas-vencidas">
                <div class="stat-pago-icon">
                  <i data-lucide="alert-triangle"></i>
                </div>
                <div class="stat-pago-info">
                  <p>Cuotas Impagas</p>
                  <h3>${estadisticas.cuotas_impagas || 0}</h3>
                </div>
              </div>
            </div>

            ${cursos.length > 0 ? `
              <div class="cursos-pagos-section">
                <h3><i data-lucide="graduation-cap"></i> Pagos por Curso</h3>
                
                <div class="cursos-cards-grid">
                  ${cursos.map(curso => `
                    <div class="curso-pago-card">
                      <div class="curso-pago-header">
                        <div class="curso-info">
                          <div class="curso-nombre">
                            <i data-lucide="book-open"></i>
                            <span>${curso.nombre_curso}</span>
                          </div>
                          <div class="curso-profesor">
                            <i data-lucide="user"></i>
                            <span>${curso.profesor}</span>
                          </div>
                        </div>
                        <div class="curso-stats">
                          <div class="curso-stat">
                            <span class="stat-label">Pagadas</span>
                            <span class="stat-value pagadas">${curso.estadisticas.cuotas_pagadas}/10</span>
                          </div>
                          <div class="curso-stat">
                            <span class="stat-label">Monto</span>
                            <span class="stat-value">$${parseFloat(curso.costo_mensual).toLocaleString('es-AR')}</span>
                          </div>
                        </div>
                      </div>

                      <div class="meses-grid">
                        ${curso.meses.map(mes => {
                          let estadoIcon = '';
                          let estadoClass = '';
                          
                          if (mes.estado === 'pagado') {
                            estadoIcon = 'check-circle';
                            estadoClass = 'pagado';
                          } else if (mes.estado === 'impago') {
                            estadoIcon = 'x-circle';
                            estadoClass = 'impago';
                          } else if (mes.estado === 'pendiente') {
                            estadoIcon = 'clock';
                            estadoClass = 'pendiente';
                          } else {
                            estadoIcon = 'circle';
                            estadoClass = 'proximo';
                          }
                          
                          return `
                            <div class="mes-item ${estadoClass}" 
                                 onclick="${mes.estado === 'pagado' ? `generarComprobantePago(${mes.id_pago})` : (mes.estado === 'pendiente' || mes.estado === 'impago' ? `window.abrirModalSeleccionMes(${curso.id_curso}, '${curso.nombre_curso}', '${mes.mes}', ${mes.monto})` : '')}"
                                 style="${mes.estado === 'pagado' || mes.estado === 'pendiente' || mes.estado === 'impago' ? 'cursor: pointer;' : ''}"
                                 ${mes.estado === 'pagado' ? 'title="Descargar comprobante"' : ''}>
                              <i data-lucide="${estadoIcon}"></i>
                              <span class="mes-nombre">${mes.mes === 'Matricula' ? 'Mat' : mes.mes.substring(0, 3)}</span>
                              ${mes.estado === 'pagado' ? `<span class="mes-fecha">${new Date(mes.fecha_pago).toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit'})}</span>` : ''}
                            </div>
                          `;
                        }).join('')}
                      </div>

                      <div class="curso-pago-footer">
                        <div class="progreso-info">
                          <div class="progreso-bar">
                            <div class="progreso-fill" style="width: ${(curso.estadisticas.cuotas_pagadas / 10) * 100}%"></div>
                          </div>
                          <span class="progreso-text">${Math.round((curso.estadisticas.cuotas_pagadas / 10) * 100)}% completado</span>
                        </div>
                        ${curso.estadisticas.cuotas_impagas > 0 ? `
                          <div class="alerta-vencido">
                            <i data-lucide="alert-triangle"></i>
                            <span>${curso.estadisticas.cuotas_impagas} cuota${curso.estadisticas.cuotas_impagas > 1 ? 's' : ''} impaga${curso.estadisticas.cuotas_impagas > 1 ? 's' : ''}</span>
                          </div>
                        ` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : `
              <div class="no-cursos-activos">
                <i data-lucide="inbox"></i>
                <h4>No tienes cursos activos</h4>
                <p>Inscr√≠bete a un curso para comenzar a gestionar tus pagos.</p>
              </div>
            `}
          </div>
        `;

        lucide.createIcons();
        loader.classList.add("hidden");
        setTimeout(() => mainContent.classList.add("active"), 100);

      } catch (error) {
        console.error("Error al cargar pagos:", error);
        mainContent.innerHTML = `
          <div class="error-container">
            <i data-lucide="alert-circle"></i>
            <h3>Error al cargar los pagos</h3>
            <p>${error.message || 'Por favor, intenta nuevamente m√°s tarde.'}</p>
          </div>
        `;
        lucide.createIcons();
        loader.classList.add("hidden");
        setTimeout(() => mainContent.classList.add("active"), 100);
      }
    },

    // Secci√≥n: Mi Perfil
    btnPerfil: async () => {
      loader.classList.remove("hidden");
      mainContent.classList.remove("active");

      try {
        const response = await fetch(`${API_URL}/alumnos/${id_alumno}/perfil`);
        const perfil = await response.json();

        mainContent.innerHTML = `
          <div class="alumno-perfil-container">
            <div class="section-header-alumno">
              <div class="header-title">
                <i data-lucide="user"></i>
                <h2>Mi Perfil</h2>
              </div>
              <p class="section-subtitle">Administra tu informaci√≥n personal</p>
            </div>

            <div class="perfil-content">
              <div class="perfil-section">
                <div class="perfil-section-header">
                  <i data-lucide="user-circle"></i>
                  <h3>Datos Personales</h3>
                </div>
                
                <div style="background: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; padding: 10px 14px; border-radius: 6px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                  <i data-lucide="lock" style="color: #f59e0b; width: 16px; height: 16px; flex-shrink: 0;"></i>
                  <span style="color: #666; font-size: 13px;">No pod√©s editar esta informaci√≥n</span>
                </div>
                
                <div class="perfil-datos-grid">
                  <div class="perfil-dato">
                    <label>Nombre Completo</label>
                    <div class="dato-valor">
                      <i data-lucide="user"></i>
                      <span>${perfil.nombre || 'No especificado'} ${perfil.apellido || ''}</span>
                    </div>
                  </div>

                  <div class="perfil-dato">
                    <label>DNI</label>
                    <div class="dato-valor">
                      <i data-lucide="id-card"></i>
                      <span>${perfil.dni || 'No especificado'}</span>
                    </div>
                  </div>

                  <div class="perfil-dato">
                    <label>Legajo</label>
                    <div class="dato-valor">
                      <i data-lucide="bookmark"></i>
                      <span>${perfil.legajo || 'No especificado'}</span>
                    </div>
                  </div>

                  <div class="perfil-dato">
                    <label>Email</label>
                    <div class="dato-valor">
                      <i data-lucide="mail"></i>
                      <span>${perfil.mail || 'No especificado'}</span>
                    </div>
                  </div>

                  <div class="perfil-dato">
                    <label>Estado</label>
                    <div class="dato-valor">
                      <span class="estado-badge ${perfil.estado || 'inactivo'}">${perfil.estado || 'Sin estado'}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="perfil-section">
                <div class="perfil-section-header">
                  <i data-lucide="info"></i>
                  <h3>Informaci√≥n Adicional</h3>
                </div>
                
                <div class="perfil-datos-grid">
                  <div class="perfil-dato">
                    <label>Fecha de Registro</label>
                    <div class="dato-valor">
                      <i data-lucide="calendar-plus"></i>
                      <span>${perfil.fecha_registro ? new Date(perfil.fecha_registro).toLocaleDateString('es-ES') : 'No disponible'}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        lucide.createIcons();
        loader.classList.add("hidden");
        setTimeout(() => mainContent.classList.add("active"), 100);

      } catch (error) {
        console.error("Error al cargar perfil:", error);
        mainContent.innerHTML = `
          <div class="error-container">
            <i data-lucide="alert-circle"></i>
            <h3>Error al cargar perfil</h3>
            <p>Por favor, intenta nuevamente m√°s tarde.</p>
          </div>
        `;
        lucide.createIcons();
        loader.classList.add("hidden");
        setTimeout(() => mainContent.classList.add("active"), 100);
      }
    },

    btnChatSoporte: () => {
      mainContent.classList.remove("active");
      mainContent.innerHTML = `<div id="userChatContainer"></div>`;
      setTimeout(() => {
        if (window.userChatManager) {
          window.userChatManager.renderChatView();
          // Ya NO llamamos init() aqu√≠ - se llam√≥ autom√°ticamente al cargar la p√°gina
        }
        mainContent.classList.add("active");
        lucide.createIcons();
      }, 100);
    },

    btnAyuda: () => {
      mainContent.classList.remove("active");
      mainContent.innerHTML = `
        <div class="ayuda-container">
          <div class="ayuda-header">
            <h2><i data-lucide="help-circle"></i> Centro de Ayuda</h2>
            <p>Gu√≠as completas para aprovechar al m√°ximo tu experiencia en CEMI</p>
            <div class="ayuda-stats">
              <div class="ayuda-stat-item">
                <div class="ayuda-stat-number">25+</div>
                <div class="ayuda-stat-label">Gu√≠as disponibles</div>
              </div>
              <div class="ayuda-stat-item">
                <div class="ayuda-stat-number">9</div>
                <div class="ayuda-stat-label">Categor√≠as</div>
              </div>
              <div class="ayuda-stat-item">
                <div class="ayuda-stat-number">24/7</div>
                <div class="ayuda-stat-label">Acceso disponible</div>
              </div>
            </div>
          </div>

          <div class="ayuda-search-container">
            <i data-lucide="search" class="search-icon"></i>
            <input type="text" class="ayuda-search-input" id="ayudaSearchInput" placeholder="¬øQu√© necesitas aprender hoy?" autocomplete="off">
            <div class="search-suggestions">
              <span class="search-suggestion" onclick="document.getElementById('ayudaSearchInput').value='pagos'; document.getElementById('ayudaSearchInput').dispatchEvent(new Event('input'))">Pagos</span>
              <span class="search-suggestion" onclick="document.getElementById('ayudaSearchInput').value='notas'; document.getElementById('ayudaSearchInput').dispatchEvent(new Event('input'))">Calificaciones</span>
              <span class="search-suggestion" onclick="document.getElementById('ayudaSearchInput').value='inscripcion'; document.getElementById('ayudaSearchInput').dispatchEvent(new Event('input'))">Inscripci√≥n</span>
              <span class="search-suggestion" onclick="document.getElementById('ayudaSearchInput').value='perfil'; document.getElementById('ayudaSearchInput').dispatchEvent(new Event('input'))">Mi Perfil</span>
            </div>
          </div>

          <div class="search-results-count" id="searchResultsCount"></div>
          <div class="no-results-message" id="noResultsMessage">
            <i data-lucide="search-x"></i>
            <h3>No se encontraron resultados</h3>
            <p>Intenta con otros t√©rminos de b√∫squeda o explora las categor√≠as</p>
          </div>

          <div class="ayuda-quick-access">
            <div class="quick-access-card" onclick="document.querySelector('[data-category=pagos] .accordion-header').click()">
              <div class="qa-icon"><i data-lucide="credit-card"></i></div>
              <div class="qa-text">
                <h4>Realizar Pagos</h4>
                <span>M√©todos y comprobantes</span>
              </div>
            </div>
            <div class="quick-access-card" onclick="document.querySelector('[data-category=calificaciones] .accordion-header').click()">
              <div class="qa-icon"><i data-lucide="clipboard-list"></i></div>
              <div class="qa-text">
                <h4>Ver Calificaciones</h4>
                <span>Notas y promedios</span>
              </div>
            </div>
            <div class="quick-access-card" onclick="document.querySelector('[data-category=cursado] .accordion-header').click()">
              <div class="qa-icon"><i data-lucide="graduation-cap"></i></div>
              <div class="qa-text">
                <h4>Inscripciones</h4>
                <span>Nuevos cursos</span>
              </div>
            </div>
            <div class="quick-access-card" onclick="document.querySelector('[data-category=chat] .accordion-header').click()">
              <div class="qa-icon"><i data-lucide="message-circle"></i></div>
              <div class="qa-text">
                <h4>Soporte</h4>
                <span>Contactar ayuda</span>
              </div>
            </div>
          </div>

          <div class="ayuda-categorias" id="ayudaCategorias">
            
            <!-- Primeros Pasos -->
            <div class="ayuda-accordion" data-category="inicio">
              <div class="accordion-header">
                <div class="accordion-title">
                  <div class="cat-icon"><i data-lucide="home"></i></div>
                  <div class="accordion-title-text">
                    <span>Primeros Pasos</span>
                    <small>Aprende a navegar y entender tu panel</small>
                  </div>
                </div>
                <div class="accordion-meta">
                  <span class="accordion-count">2 gu√≠as</span>
                  <i data-lucide="chevron-down" class="accordion-icon"></i>
                </div>
              </div>
              <div class="accordion-content">
                <div class="accordion-body">
                  <div class="guia-list">
                    <div class="guia-item" data-keywords="inicio bienvenida panel dashboard navegacion menu">
                      <div class="guia-icon"><i data-lucide="layout-dashboard"></i></div>
                      <div class="guia-content">
                        <h4>Navegaci√≥n del Panel</h4>
                        <p>El men√∫ lateral izquierdo te permite acceder a todas las secciones: Mis Cursos, Cursado, Calificaciones, Pagos, Perfil y m√°s. Haz clic en cualquier opci√≥n para cargar esa secci√≥n.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">B√°sico</span>
                          <span class="guia-tag">Navegaci√≥n</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="entender dashboard resumen informacion estadisticas">
                      <div class="guia-icon"><i data-lucide="info"></i></div>
                      <div class="guia-content">
                        <h4>Entender tu Dashboard</h4>
                        <p>Al ingresar ver√°s un resumen de tus cursos activos, tu promedio general y tu progreso acad√©mico. Las tarjetas de estad√≠sticas te muestran informaci√≥n clave de un vistazo.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">B√°sico</span>
                          <span class="guia-tag">Estad√≠sticas</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mis Cursos -->
            <div class="ayuda-accordion" data-category="cursos">
              <div class="accordion-header">
                <div class="accordion-title">
                  <div class="cat-icon"><i data-lucide="book-open"></i></div>
                  <div class="accordion-title-text">
                    <span>Mis Cursos</span>
                    <small>Visualiza y gestiona tus cursos inscritos</small>
                  </div>
                </div>
                <div class="accordion-meta">
                  <span class="accordion-count">3 gu√≠as</span>
                  <i data-lucide="chevron-down" class="accordion-icon"></i>
                </div>
              </div>
              <div class="accordion-content">
                <div class="accordion-body">
                  <div class="guia-list">
                    <div class="guia-item" data-keywords="cursos inscritos ver lista mis cursos matriculado">
                      <div class="guia-icon"><i data-lucide="book-open"></i></div>
                      <div class="guia-content">
                        <h4>Ver Cursos Inscritos</h4>
                        <p>En esta secci√≥n encontrar√°s todos los cursos en los que est√°s matriculado. Cada tarjeta muestra el nombre del curso, idioma, nivel y tu progreso actual.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Cursos</span>
                          <span class="guia-tag">Lista</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="detalles curso informacion profesor horario aula">
                      <div class="guia-icon"><i data-lucide="eye"></i></div>
                      <div class="guia-content">
                        <h4>Detalles de un Curso</h4>
                        <p>Haz clic en cualquier tarjeta de curso para ver informaci√≥n detallada: profesor asignado, horario de clases, aula y tus calificaciones espec√≠ficas.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Detalles</span>
                          <span class="guia-tag">Horarios</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="progreso barra porcentaje avance notas rendimiento">
                      <div class="guia-icon"><i data-lucide="trending-up"></i></div>
                      <div class="guia-content">
                        <h4>Entender el Progreso</h4>
                        <p>La barra de progreso indica tu avance basado en calificaciones. Verde = aprobado (7+), amarillo = en proceso, rojo = requiere atenci√≥n.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Progreso</span>
                          <span class="guia-tag">Rendimiento</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cursado -->
            <div class="ayuda-accordion" data-category="cursado">
              <div class="accordion-header">
                <div class="accordion-title">
                  <div class="cat-icon"><i data-lucide="graduation-cap"></i></div>
                  <div class="accordion-title-text">
                    <span>Cursado e Inscripciones</span>
                    <small>Explora cursos disponibles y solicita inscripci√≥n</small>
                  </div>
                </div>
                <div class="accordion-meta">
                  <span class="accordion-count">3 gu√≠as</span>
                  <i data-lucide="chevron-down" class="accordion-icon"></i>
                </div>
              </div>
              <div class="accordion-content">
                <div class="accordion-body">
                  <div class="guia-list">
                    <div class="guia-item" data-keywords="catalogo cursos disponibles explorar buscar filtrar">
                      <div class="guia-icon"><i data-lucide="search"></i></div>
                      <div class="guia-content">
                        <h4>Cat√°logo de Cursos</h4>
                        <p>Explora todos los cursos disponibles en el instituto. Usa el buscador para filtrar por nombre, idioma o profesor. Cada curso muestra disponibilidad.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Cat√°logo</span>
                          <span class="guia-tag">B√∫squeda</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="inscripcion solicitar inscribirse curso nuevo matricula">
                      <div class="guia-icon"><i data-lucide="user-plus"></i></div>
                      <div class="guia-content">
                        <h4>Solicitar Inscripci√≥n</h4>
                        <p>Para inscribirte en un nuevo curso, haz clic en "Solicitar Inscripci√≥n" de la tarjeta del curso. Un administrador revisar√° tu solicitud.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Inscripci√≥n</span>
                          <span class="guia-tag">Solicitud</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="disponibilidad cupos lugares disponibles lleno vacantes">
                      <div class="guia-icon"><i data-lucide="users"></i></div>
                      <div class="guia-content">
                        <h4>Verificar Disponibilidad</h4>
                        <p>Cada curso muestra cupos disponibles. Si est√° lleno, contacta a administraci√≥n para alternativas o lista de espera.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Cupos</span>
                          <span class="guia-tag">Disponibilidad</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Calificaciones -->
            <div class="ayuda-accordion" data-category="calificaciones">
              <div class="accordion-header">
                <div class="accordion-title">
                  <div class="cat-icon"><i data-lucide="clipboard-list"></i></div>
                  <div class="accordion-title-text">
                    <span>Mis Calificaciones</span>
                    <small>Consulta notas, promedios e historial acad√©mico</small>
                  </div>
                </div>
                <div class="accordion-meta">
                  <span class="accordion-count">3 gu√≠as</span>
                  <i data-lucide="chevron-down" class="accordion-icon"></i>
                </div>
              </div>
              <div class="accordion-content">
                <div class="accordion-body">
                  <div class="guia-list">
                    <div class="guia-item" data-keywords="notas ver calificaciones parciales final examenes">
                      <div class="guia-icon"><i data-lucide="file-text"></i></div>
                      <div class="guia-content">
                        <h4>Ver Calificaciones</h4>
                        <p>Consulta tus notas de Parcial 1, Parcial 2 y Final de cada curso. El sistema calcula autom√°ticamente tu promedio por curso y general.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Notas</span>
                          <span class="guia-tag">Parciales</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="promedio calcular media notas general rendimiento">
                      <div class="guia-icon"><i data-lucide="calculator"></i></div>
                      <div class="guia-content">
                        <h4>Entender Promedios</h4>
                        <p>El promedio se calcula sumando tus notas y dividiendo por evaluaciones rendidas. El promedio general incluye todos tus cursos activos.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Promedio</span>
                          <span class="guia-tag">C√°lculo</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="historial academico registro notas anteriores evolucion">
                      <div class="guia-icon"><i data-lucide="history"></i></div>
                      <div class="guia-content">
                        <h4>Historial Acad√©mico</h4>
                        <p>Tu historial muestra todas las calificaciones obtenidas a lo largo del tiempo, permiti√©ndote ver tu evoluci√≥n acad√©mica.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Historial</span>
                          <span class="guia-tag">Evoluci√≥n</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pagos -->
            <div class="ayuda-accordion" data-category="pagos">
              <div class="accordion-header">
                <div class="accordion-title">
                  <div class="cat-icon"><i data-lucide="credit-card"></i></div>
                  <div class="accordion-title-text">
                    <span>Mis Pagos</span>
                    <small>M√©todos de pago, cuotas y comprobantes</small>
                  </div>
                </div>
                <div class="accordion-meta">
                  <span class="accordion-count">5 gu√≠as</span>
                  <i data-lucide="chevron-down" class="accordion-icon"></i>
                </div>
              </div>
              <div class="accordion-content">
                <div class="accordion-body">
                  <div class="guia-list">
                    <div class="guia-item" data-keywords="estado pagos cuotas pendientes ver deuda">
                      <div class="guia-icon"><i data-lucide="receipt"></i></div>
                      <div class="guia-content">
                        <h4>Ver Estado de Pagos</h4>
                        <p>Consulta el estado de tus cuotas: pagadas, pendientes o vencidas. El sistema muestra un resumen completo de tu situaci√≥n financiera.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Estado</span>
                          <span class="guia-tag">Cuotas</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="pagar cuota realizar pago metodo mercadopago efectivo abonar">
                      <div class="guia-icon"><i data-lucide="wallet"></i></div>
                      <div class="guia-content">
                        <h4>Realizar un Pago</h4>
                        <p>Selecciona el mes a abonar y elige el m√©todo: Mercado Pago (online) o Efectivo (genera ticket para pagar presencialmente).</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Pagar</span>
                          <span class="guia-tag">M√©todos</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="efectivo ticket comprobante pago presencial secretaria">
                      <div class="guia-icon"><i data-lucide="banknote"></i></div>
                      <div class="guia-content">
                        <h4>Pago en Efectivo</h4>
                        <p>Al elegir efectivo, se genera un ticket con c√≥digo √∫nico. Presenta este ticket en secretar√≠a para completar el pago. Puedes descargarlo o imprimirlo.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Efectivo</span>
                          <span class="guia-tag">Ticket</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="mercadopago online tarjeta debito credito digital">
                      <div class="guia-icon"><i data-lucide="smartphone"></i></div>
                      <div class="guia-content">
                        <h4>Pago con Mercado Pago</h4>
                        <p>El pago online te redirige a Mercado Pago donde puedes usar tarjeta de d√©bito, cr√©dito o dinero en cuenta. Se acredita autom√°ticamente.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Online</span>
                          <span class="guia-tag">Tarjeta</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="descargar ticket comprobante pdf imprimir recibo">
                      <div class="guia-icon"><i data-lucide="download"></i></div>
                      <div class="guia-content">
                        <h4>Descargar Comprobantes</h4>
                        <p>Descarga tickets de pago en efectivo o comprobantes de pagos realizados para tu registro personal desde la secci√≥n de pagos.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Descarga</span>
                          <span class="guia-tag">PDF</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mi Perfil -->
            <div class="ayuda-accordion" data-category="perfil">
              <div class="accordion-header">
                <div class="accordion-title">
                  <div class="cat-icon"><i data-lucide="user"></i></div>
                  <div class="accordion-title-text">
                    <span>Mi Perfil</span>
                    <small>Personaliza tu cuenta y actualiza datos</small>
                  </div>
                </div>
                <div class="accordion-meta">
                  <span class="accordion-count">2 gu√≠as</span>
                  <i data-lucide="chevron-down" class="accordion-icon"></i>
                </div>
              </div>
              <div class="accordion-content">
                <div class="accordion-body">
                  <div class="guia-list">
                    <div class="guia-item" data-keywords="avatar foto perfil imagen cambiar subir fotografia">
                      <div class="guia-icon"><i data-lucide="camera"></i></div>
                      <div class="guia-content">
                        <h4>Cambiar Avatar</h4>
                        <p>Personaliza tu perfil subiendo una foto. Haz clic en tu avatar actual y selecciona una imagen de tu dispositivo (formatos: JPG, PNG).</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Avatar</span>
                          <span class="guia-tag">Foto</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="datos personales editar informacion telefono email contacto">
                      <div class="guia-icon"><i data-lucide="edit"></i></div>
                      <div class="guia-content">
                        <h4>Actualizar Datos Personales</h4>
                        <p>Mant√©n tu informaci√≥n actualizada: tel√©fono, email de contacto. Datos como DNI y legajo solo los modifica administraci√≥n.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Datos</span>
                          <span class="guia-tag">Contacto</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Classroom -->
            <div class="ayuda-accordion" data-category="classroom">
              <div class="accordion-header">
                <div class="accordion-title">
                  <div class="cat-icon"><i data-lucide="school"></i></div>
                  <div class="accordion-title-text">
                    <span>Classroom</span>
                    <small>Accede a materiales y recursos de estudio</small>
                  </div>
                </div>
                <div class="accordion-meta">
                  <span class="accordion-count">2 gu√≠as</span>
                  <i data-lucide="chevron-down" class="accordion-icon"></i>
                </div>
              </div>
              <div class="accordion-content">
                <div class="accordion-body">
                  <div class="guia-list">
                    <div class="guia-item" data-keywords="classroom google acceder materiales recursos plataforma">
                      <div class="guia-icon"><i data-lucide="external-link"></i></div>
                      <div class="guia-content">
                        <h4>Acceder a Classroom</h4>
                        <p>Classroom te conecta con Google Classroom donde encontrar√°s materiales de estudio, tareas y recursos compartidos por tus profesores.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Google</span>
                          <span class="guia-tag">Acceso</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="materiales archivos documentos descargar recursos tareas">
                      <div class="guia-icon"><i data-lucide="folder-open"></i></div>
                      <div class="guia-content">
                        <h4>Acceder a Materiales</h4>
                        <p>Una vez en Classroom, podr√°s ver y descargar los materiales que tus profesores hayan compartido para cada curso.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Materiales</span>
                          <span class="guia-tag">Descargas</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Chat Soporte -->
            <div class="ayuda-accordion" data-category="chat">
              <div class="accordion-header">
                <div class="accordion-title">
                  <div class="cat-icon"><i data-lucide="message-circle"></i></div>
                  <div class="accordion-title-text">
                    <span>Chat de Soporte</span>
                    <small>Comun√≠cate con el equipo de administraci√≥n</small>
                  </div>
                </div>
                <div class="accordion-meta">
                  <span class="accordion-count">2 gu√≠as</span>
                  <i data-lucide="chevron-down" class="accordion-icon"></i>
                </div>
              </div>
              <div class="accordion-content">
                <div class="accordion-body">
                  <div class="guia-list">
                    <div class="guia-item" data-keywords="contactar administracion mensaje soporte ayuda consulta">
                      <div class="guia-icon"><i data-lucide="send"></i></div>
                      <div class="guia-content">
                        <h4>Contactar Administraci√≥n</h4>
                        <p>Usa el Chat de Soporte para comunicarte directamente con el equipo administrativo. Env√≠a consultas, dudas o reporta problemas.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Contacto</span>
                          <span class="guia-tag">Consultas</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="notificaciones mensajes nuevos badge alerta respuesta">
                      <div class="guia-icon"><i data-lucide="bell"></i></div>
                      <div class="guia-content">
                        <h4>Notificaciones de Chat</h4>
                        <p>Cuando recibas respuesta, ver√°s una insignia en Chat Soporte. Habilita las notificaciones del navegador para alertas en tiempo real.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Alertas</span>
                          <span class="guia-tag">Respuestas</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- FAQ -->
            <div class="ayuda-accordion" data-category="faq">
              <div class="accordion-header">
                <div class="accordion-title">
                  <div class="cat-icon"><i data-lucide="message-square-text"></i></div>
                  <div class="accordion-title-text">
                    <span>Preguntas Frecuentes</span>
                    <small>Respuestas r√°pidas a dudas comunes</small>
                  </div>
                </div>
                <div class="accordion-meta">
                  <span class="accordion-count">4 gu√≠as</span>
                  <i data-lucide="chevron-down" class="accordion-icon"></i>
                </div>
              </div>
              <div class="accordion-content">
                <div class="accordion-body">
                  <div class="guia-list">
                    <div class="guia-item" data-keywords="contrase√±a olvid√© recuperar acceso login clave">
                      <div class="guia-icon"><i data-lucide="key"></i></div>
                      <div class="guia-content">
                        <h4>¬øOlvid√© mi contrase√±a?</h4>
                        <p>Contacta a administraci√≥n a trav√©s del formulario de ayuda o acude presencialmente a secretar√≠a para restablecer tu contrase√±a.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Contrase√±a</span>
                          <span class="guia-tag">Acceso</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="datos incorrectos error informacion mal legajo corregir">
                      <div class="guia-icon"><i data-lucide="alert-circle"></i></div>
                      <div class="guia-content">
                        <h4>¬øMis datos est√°n incorrectos?</h4>
                        <p>Si notas errores en tu informaci√≥n personal (nombre, DNI, legajo), comun√≠cate con administraci√≥n para la correcci√≥n.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Correcci√≥n</span>
                          <span class="guia-tag">Datos</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="baja curso desinscribir eliminar salir abandonar">
                      <div class="guia-icon"><i data-lucide="user-minus"></i></div>
                      <div class="guia-content">
                        <h4>¬øC√≥mo me doy de baja de un curso?</h4>
                        <p>Para solicitar la baja, contacta a administraci√≥n indicando el curso del que deseas desvincularte y el motivo.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Baja</span>
                          <span class="guia-tag">Curso</span>
                        </div>
                      </div>
                    </div>
                    <div class="guia-item" data-keywords="problema error funciona mal bug reporte tecnico">
                      <div class="guia-icon"><i data-lucide="bug"></i></div>
                      <div class="guia-content">
                        <h4>¬øEncontr√© un error en el sistema?</h4>
                        <p>Rep√≥rtalo a trav√©s del Chat de Soporte describiendo qu√© sucedi√≥ y en qu√© secci√≥n. Esto nos ayuda a mejorar el sistema.</p>
                        <div class="guia-tags">
                          <span class="guia-tag">Error</span>
                          <span class="guia-tag">Reporte</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

          <div class="ayuda-tips">
            <h3><i data-lucide="lightbulb"></i> Tips R√°pidos para Estudiantes</h3>
            <div class="tips-list">
              <div class="tip-badge"><i data-lucide="refresh-cw"></i> Recarga la p√°gina si algo no carga correctamente</div>
              <div class="tip-badge"><i data-lucide="bell"></i> Habilita notificaciones para recibir alertas importantes</div>
              <div class="tip-badge"><i data-lucide="smartphone"></i> El sistema funciona perfectamente desde tu celular</div>
              <div class="tip-badge"><i data-lucide="message-circle"></i> El chat de soporte es el canal m√°s r√°pido para ayuda</div>
            </div>
          </div>

          <div class="ayuda-footer">
            <p>¬øNo encontraste lo que buscabas? Estamos aqu√≠ para ayudarte.</p>
            <div class="ayuda-footer-links">
              <span class="ayuda-footer-link" onclick="document.getElementById('btnChatSoporte').click()">
                <i data-lucide="message-circle"></i> Abrir Chat de Soporte
              </span>
              <span class="ayuda-footer-link" onclick="window.open('ayuda.html', '_blank')">
                <i data-lucide="external-link"></i> Centro de Ayuda Completo
              </span>
            </div>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        mainContent.classList.add("active");
        lucide.createIcons();
        initAyudaInteractivity();
      }, 100);
    }
  };

  // Funci√≥n para inicializar interactividad de la secci√≥n Ayuda
  function initAyudaInteractivity() {
    // Acordeones
    document.querySelectorAll('.accordion-header').forEach(header => {
      header.addEventListener('click', () => {
        const accordion = header.parentElement;
        accordion.classList.toggle('open');
      });
    });

    // Buscador
    const searchInput = document.getElementById('ayudaSearchInput');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        filterAyudaContent(query);
      });
    }
    
    // Modales de gu√≠a
    document.querySelectorAll('.guia-item').forEach(item => {
      item.addEventListener('click', () => {
        openGuiaModal(item);
      });
    });
  }

  // Datos detallados para gu√≠as de alumno
  const guiasDetalladas = {
    'Navegaci√≥n del Panel': {
      descripcion: 'El men√∫ lateral izquierdo es tu centro de control. Desde aqu√≠ accedes a todas las secciones del sistema.',
      pasos: [
        { titulo: 'Localiza el men√∫ lateral', desc: 'Est√° ubicado en el lado izquierdo de la pantalla.' },
        { titulo: 'Explora las secciones', desc: 'Cada √≠cono representa una secci√≥n diferente.' },
        { titulo: 'Haz clic para navegar', desc: 'Un solo clic te llevar√° a la secci√≥n seleccionada.' },
        { titulo: 'Observa los indicadores', desc: 'Los badges rojos indican notificaciones pendientes.' }
      ],
      tip: 'En dispositivos m√≥viles, el men√∫ se oculta autom√°ticamente. Usa el √≠cono de men√∫ para desplegarlo.'
    },
    'Entender tu Dashboard': {
      descripcion: 'Tu dashboard es tu centro de informaci√≥n. Aqu√≠ ves un resumen de todo lo importante de un vistazo.',
      pasos: [
        { titulo: 'Tarjetas de estad√≠sticas', desc: 'Muestran cursos activos, promedio y progreso.' },
        { titulo: 'Cursos destacados', desc: 'Acceso r√°pido a tus cursos principales.' },
        { titulo: 'Notificaciones', desc: 'Alertas sobre pagos, notas o mensajes.' },
        { titulo: 'Accesos directos', desc: 'Botones para las funciones m√°s usadas.' }
      ],
      tip: 'Revisa tu dashboard al inicio de cada sesi√≥n para estar al d√≠a.'
    },
    'Ver Cursos Inscritos': {
      descripcion: 'Consulta todos los cursos donde est√°s matriculado y su informaci√≥n detallada.',
      pasos: [
        { titulo: 'Ve a Mis Cursos', desc: 'Desde el men√∫ lateral.' },
        { titulo: 'Revisa las tarjetas', desc: 'Cada curso muestra su informaci√≥n b√°sica.' },
        { titulo: 'Consulta el progreso', desc: 'La barra indica tu avance en el curso.' },
        { titulo: 'Accede a detalles', desc: 'Haz clic para ver m√°s informaci√≥n.' }
      ],
      tip: 'El color de la barra de progreso indica tu estado: verde es bueno, amarillo es alerta.'
    },
    'Detalles de un Curso': {
      descripcion: 'Accede a toda la informaci√≥n de un curso: profesor, horario, aula y tus calificaciones.',
      pasos: [
        { titulo: 'Selecciona el curso', desc: 'Haz clic en la tarjeta del curso.' },
        { titulo: 'Ve la informaci√≥n', desc: 'Horario, aula, profesor asignado.' },
        { titulo: 'Consulta tus notas', desc: 'Parciales y final aparecen aqu√≠.' },
        { titulo: 'Revisa tu asistencia', desc: 'Historial de asistencias del curso.' }
      ],
      tip: 'Guarda el horario en tu calendario personal para no olvidar las clases.'
    },
    'Entender el Progreso': {
      descripcion: 'La barra de progreso refleja tu rendimiento acad√©mico basado en tus calificaciones.',
      pasos: [
        { titulo: 'Verde (7-10)', desc: 'Excelente rendimiento, vas por buen camino.' },
        { titulo: 'Amarillo (5-6.99)', desc: 'Aprobado pero podr√≠as mejorar.' },
        { titulo: 'Rojo (0-4.99)', desc: 'Necesitas atenci√≥n, considera refuerzo.' },
        { titulo: 'Promedio general', desc: 'Se calcula con todas tus notas.' }
      ],
      tip: 'Habla con tu profesor si ves rojo, hay tiempo para mejorar.'
    },
    'Cat√°logo de Cursos': {
      descripcion: 'Explora todos los cursos disponibles en el instituto para futuras inscripciones.',
      pasos: [
        { titulo: 'Ve a Cursado', desc: 'Desde el men√∫ lateral.' },
        { titulo: 'Navega el cat√°logo', desc: 'Todos los cursos disponibles aparecen aqu√≠.' },
        { titulo: 'Usa filtros', desc: 'Por idioma, nivel o disponibilidad.' },
        { titulo: 'Revisa la info', desc: 'Cada tarjeta muestra horario y cupos.' }
      ],
      tip: 'Los cursos con pocos cupos se llenan r√°pido, solicita inscripci√≥n a tiempo.'
    },
    'Solicitar Inscripci√≥n': {
      descripcion: 'Pide inscribirte en nuevos cursos. Un administrador revisar√° tu solicitud.',
      pasos: [
        { titulo: 'Encuentra el curso', desc: 'Navega el cat√°logo de cursos.' },
        { titulo: 'Verifica requisitos', desc: 'Algunos cursos requieren nivel previo.' },
        { titulo: 'Haz clic en inscribir', desc: 'Bot√≥n "Solicitar Inscripci√≥n".' },
        { titulo: 'Espera confirmaci√≥n', desc: 'Recibir√°s respuesta por el sistema.' }
      ],
      tip: 'Aseg√∫rate de no tener conflictos de horario con tus cursos actuales.'
    },
    'Verificar Disponibilidad': {
      descripcion: 'Cada curso tiene un cupo m√°ximo. Verifica si hay lugar antes de solicitar inscripci√≥n.',
      pasos: [
        { titulo: 'Busca el indicador', desc: 'Cada curso muestra cupos disponibles.' },
        { titulo: 'Interpreta los colores', desc: 'Verde hay lugar, rojo lleno.' },
        { titulo: 'Consulta alternativas', desc: 'Si est√° lleno, busca otros horarios.' },
        { titulo: 'Contacta soporte', desc: 'Para listas de espera o excepciones.' }
      ],
      tip: 'A inicio de cuatrimestre hay m√°s movimiento, los cupos pueden liberarse.'
    },
    'Ver Calificaciones': {
      descripcion: 'Consulta tus notas de parciales y finales de cada curso.',
      pasos: [
        { titulo: 'Ve a Calificaciones', desc: 'Desde el men√∫ lateral.' },
        { titulo: 'Selecciona el curso', desc: 'Si tienes varios, elige uno.' },
        { titulo: 'Revisa tus notas', desc: 'Parcial 1, Parcial 2, Final.' },
        { titulo: 'Consulta el promedio', desc: 'Se calcula autom√°ticamente.' }
      ],
      tip: 'Las notas se actualizan cuando el profesor las carga, puede demorar unos d√≠as.'
    },
    'Entender Promedios': {
      descripcion: 'El promedio se calcula autom√°ticamente basado en tus calificaciones registradas.',
      pasos: [
        { titulo: 'Promedio por curso', desc: 'Suma de notas dividido cantidad de evaluaciones.' },
        { titulo: 'Promedio general', desc: 'Incluye todos tus cursos activos.' },
        { titulo: 'Peso de evaluaciones', desc: 'Todas las evaluaciones valen igual.' },
        { titulo: 'Actualizaci√≥n', desc: 'Se recalcula con cada nueva nota.' }
      ],
      tip: 'El promedio general es importante para becas y certificados.'
    },
    'Historial Acad√©mico': {
      descripcion: 'Tu historial muestra toda tu trayectoria acad√©mica en el instituto.',
      pasos: [
        { titulo: 'Accede al historial', desc: 'Desde la secci√≥n Calificaciones.' },
        { titulo: 'Revisa cursos pasados', desc: 'Todos tus cursos completados.' },
        { titulo: 'Consulta notas finales', desc: 'Cada curso muestra nota de cierre.' },
        { titulo: 'Solicita certificados', desc: 'Contacta administraci√≥n si necesitas.' }
      ],
      tip: 'El historial es tu carta de presentaci√≥n acad√©mica, cu√≠dalo.'
    },
    'Ver Estado de Pagos': {
      descripcion: 'Consulta el estado de tus cuotas: pagadas, pendientes o vencidas.',
      pasos: [
        { titulo: 'Ve a Mis Pagos', desc: 'Desde el men√∫ lateral.' },
        { titulo: 'Revisa la lista', desc: 'Cada cuota aparece con su estado.' },
        { titulo: 'Identifica pendientes', desc: 'En amarillo o rojo seg√∫n urgencia.' },
        { titulo: 'Consulta vencimientos', desc: 'Fechas l√≠mite de cada cuota.' }
      ],
      tip: 'Mant√©n tus pagos al d√≠a para evitar recargos e inconvenientes.'
    },
    'Realizar un Pago': {
      descripcion: 'Paga tus cuotas de forma simple eligiendo el m√©todo que prefieras.',
      pasos: [
        { titulo: 'Selecciona la cuota', desc: 'Elige el mes a pagar.' },
        { titulo: 'Elige m√©todo de pago', desc: 'Mercado Pago o Efectivo.' },
        { titulo: 'Completa el proceso', desc: 'Sigue las instrucciones seg√∫n m√©todo.' },
        { titulo: 'Guarda el comprobante', desc: 'Siempre conserva tu recibo.' }
      ],
      tip: 'Mercado Pago se acredita al instante, efectivo requiere ir a secretar√≠a.'
    },
    'Pago en Efectivo': {
      descripcion: 'Genera un ticket para pagar en efectivo presencialmente en secretar√≠a.',
      pasos: [
        { titulo: 'Selecciona la cuota', desc: 'Elige el mes a pagar.' },
        { titulo: 'Elige "Efectivo"', desc: 'Como m√©todo de pago.' },
        { titulo: 'Descarga el ticket', desc: 'Se genera un PDF con c√≥digo √∫nico.' },
        { titulo: 'Presenta en secretar√≠a', desc: 'Paga en efectivo y entr√©galo.' }
      ],
      tip: 'El ticket tiene fecha de vencimiento, pres√©ntalo a tiempo.'
    },
    'Pago con Mercado Pago': {
      descripcion: 'Paga online con tarjeta o dinero en cuenta de Mercado Pago.',
      pasos: [
        { titulo: 'Selecciona la cuota', desc: 'Elige el mes a pagar.' },
        { titulo: 'Elige "Mercado Pago"', desc: 'Como m√©todo de pago.' },
        { titulo: 'Ser√°s redirigido', desc: 'A la p√°gina segura de MP.' },
        { titulo: 'Completa el pago', desc: 'Con tarjeta o dinero en cuenta.' }
      ],
      tip: 'Aseg√∫rate de tener fondos o tarjeta habilitada antes de iniciar.'
    },
    'Descargar Comprobantes': {
      descripcion: 'Descarga tickets y comprobantes de tus pagos para tu registro.',
      pasos: [
        { titulo: 'Ve a Mis Pagos', desc: 'Desde el men√∫ lateral.' },
        { titulo: 'Busca el pago', desc: 'Localiza el pago del que necesitas comprobante.' },
        { titulo: 'Haz clic en descargar', desc: '√çcono de descarga junto al pago.' },
        { titulo: 'Guarda el archivo', desc: 'Se descarga un PDF.' }
      ],
      tip: 'Guarda todos tus comprobantes en una carpeta organizada por fecha.'
    },
    'Cambiar Avatar': {
      descripcion: 'Personaliza tu perfil subiendo una foto o imagen.',
      pasos: [
        { titulo: 'Ve a Mi Perfil', desc: 'Desde el men√∫ lateral.' },
        { titulo: 'Haz clic en tu avatar', desc: 'El c√≠rculo con tu imagen actual.' },
        { titulo: 'Selecciona archivo', desc: 'Elige una imagen de tu dispositivo.' },
        { titulo: 'Confirma el cambio', desc: 'La imagen se actualiza autom√°ticamente.' }
      ],
      tip: 'Usa una foto clara de tu rostro para f√°cil identificaci√≥n.'
    },
    'Actualizar Datos Personales': {
      descripcion: 'Mant√©n tu informaci√≥n de contacto actualizada para comunicaciones importantes.',
      pasos: [
        { titulo: 'Ve a Mi Perfil', desc: 'Desde el men√∫ lateral.' },
        { titulo: 'Haz clic en editar', desc: 'Bot√≥n para modificar datos.' },
        { titulo: 'Actualiza la informaci√≥n', desc: 'Tel√©fono, email de contacto.' },
        { titulo: 'Guarda los cambios', desc: 'Confirma las modificaciones.' }
      ],
      tip: 'Datos como DNI y legajo solo los puede modificar administraci√≥n.'
    },
    'Acceder a Classroom': {
      descripcion: 'Conecta con Google Classroom para acceder a materiales de estudio.',
      pasos: [
        { titulo: 'Ve a Classroom', desc: 'Desde el men√∫ lateral.' },
        { titulo: 'Haz clic en acceder', desc: 'Ser√°s redirigido a Google.' },
        { titulo: 'Inicia sesi√≥n', desc: 'Con tu cuenta de Google.' },
        { titulo: 'Explora los cursos', desc: 'Ver√°s los cursos donde est√°s inscrito.' }
      ],
      tip: 'Usa la misma cuenta de Google siempre para no perder acceso.'
    },
    'Acceder a Materiales': {
      descripcion: 'Descarga materiales de estudio compartidos por tus profesores.',
      pasos: [
        { titulo: 'Ingresa a Classroom', desc: 'Conecta con tu cuenta Google.' },
        { titulo: 'Selecciona el curso', desc: 'El que te interesa revisar.' },
        { titulo: 'Busca Materiales', desc: 'Secci√≥n de recursos del curso.' },
        { titulo: 'Descarga lo que necesites', desc: 'PDFs, documentos, presentaciones.' }
      ],
      tip: 'Descarga los materiales a tu dispositivo para estudiar sin conexi√≥n.'
    },
    'Contactar Administraci√≥n': {
      descripcion: 'Usa el chat de soporte para comunicarte directamente con el equipo administrativo.',
      pasos: [
        { titulo: 'Ve a Chat Soporte', desc: 'Desde el men√∫ lateral.' },
        { titulo: 'Escribe tu mensaje', desc: 'Describe tu consulta o problema.' },
        { titulo: 'Env√≠a el mensaje', desc: 'Presiona Enter o el bot√≥n enviar.' },
        { titulo: 'Espera respuesta', desc: 'Te notificar√°n cuando respondan.' }
      ],
      tip: 'S√© claro y espec√≠fico en tu consulta para recibir mejor ayuda.'
    },
    'Notificaciones de Chat': {
      descripcion: 'Recibe alertas cuando el equipo de soporte responda a tus consultas.',
      pasos: [
        { titulo: 'Observa el badge', desc: 'N√∫mero rojo en Chat Soporte.' },
        { titulo: 'Habilita notificaciones', desc: 'Acepta cuando el navegador pregunte.' },
        { titulo: 'Recibir√°s alertas', desc: 'Incluso con la pesta√±a cerrada.' },
        { titulo: 'Revisa mensajes nuevos', desc: 'Haz clic para ver respuestas.' }
      ],
      tip: 'Las notificaciones funcionan mejor si mantienes sesi√≥n activa.'
    },
    '¬øOlvid√© mi contrase√±a?': {
      descripcion: 'Si olvidaste tu contrase√±a, hay formas de recuperar el acceso a tu cuenta.',
      pasos: [
        { titulo: 'No te preocupes', desc: 'Es un problema com√∫n con soluci√≥n.' },
        { titulo: 'Contacta administraci√≥n', desc: 'V√≠a email o presencialmente.' },
        { titulo: 'Verifica tu identidad', desc: 'Con DNI o datos personales.' },
        { titulo: 'Recibe nueva contrase√±a', desc: 'Te dar√°n una temporal para cambiar.' }
      ],
      tip: 'Usa un gestor de contrase√±as para no olvidarlas en el futuro.'
    },
    '¬øMis datos est√°n incorrectos?': {
      descripcion: 'Si encuentras errores en tu informaci√≥n personal, puedes solicitar correcci√≥n.',
      pasos: [
        { titulo: 'Identifica el error', desc: 'Qu√© dato espec√≠fico est√° mal.' },
        { titulo: 'Contacta administraci√≥n', desc: 'Por chat o presencialmente.' },
        { titulo: 'Proporciona informaci√≥n correcta', desc: 'Y documentaci√≥n si es necesario.' },
        { titulo: 'Espera la correcci√≥n', desc: 'Los cambios se reflejan pronto.' }
      ],
      tip: 'DNI y legajo requieren documentaci√≥n para modificarse.'
    },
    '¬øC√≥mo me doy de baja de un curso?': {
      descripcion: 'Si necesitas abandonar un curso, debes solicitar la baja formalmente.',
      pasos: [
        { titulo: 'Eval√∫a tu decisi√≥n', desc: 'La baja puede afectar tu historial.' },
        { titulo: 'Contacta administraci√≥n', desc: 'Explica tu situaci√≥n.' },
        { titulo: 'Completa el proceso', desc: 'Puede requerir firma o confirmaci√≥n.' },
        { titulo: 'Verifica la baja', desc: 'El curso desaparecer√° de tu lista.' }
      ],
      tip: 'Consulta sobre per√≠odos de baja sin penalizaci√≥n antes de decidir.'
    },
    '¬øEncontr√© un error en el sistema?': {
      descripcion: 'Los errores deben reportarse para que el equipo t√©cnico pueda solucionarlos.',
      pasos: [
        { titulo: 'Documenta el error', desc: 'Anota qu√© estabas haciendo.' },
        { titulo: 'Captura pantalla', desc: 'Si es posible, toma una captura.' },
        { titulo: 'Anota los pasos', desc: 'Describe c√≥mo reproducir el problema.' },
        { titulo: 'Reporta por chat', desc: 'Env√≠a la informaci√≥n a soporte.' }
      ],
      tip: 'Cuanto m√°s detallada sea tu descripci√≥n, m√°s r√°pido podremos solucionarlo.'
    }
  };

  function openGuiaModal(item) {
    const title = item.querySelector('h4')?.textContent || 'Gu√≠a';
    const description = item.querySelector('p')?.textContent || '';
    const iconHTML = item.querySelector('.guia-icon')?.innerHTML || '';
    const tags = item.querySelectorAll('.guia-tag');
    
    const datos = guiasDetalladas[title] || {
      descripcion: description,
      pasos: [
        { titulo: 'Paso 1', desc: 'Sigue las instrucciones en pantalla.' },
        { titulo: 'Paso 2', desc: 'Completa la informaci√≥n requerida.' },
        { titulo: 'Paso 3', desc: 'Confirma los cambios realizados.' },
        { titulo: 'Paso 4', desc: 'Verifica que todo est√© correcto.' }
      ],
      tip: 'Si necesitas ayuda adicional, contacta al equipo de soporte.'
    };
    
    let tagsHTML = '';
    tags.forEach(tag => {
      tagsHTML += `<span class="guia-tag">${tag.textContent}</span>`;
    });
    
    const modalHTML = `
      <div class="guia-modal-overlay active" onclick="closeGuiaModal(event)">
        <div class="guia-modal" onclick="event.stopPropagation()">
          <div class="guia-modal-header">
            <button class="guia-modal-close" onclick="closeGuiaModal()">
              <i data-lucide="x"></i>
            </button>
            <div class="guia-modal-icon">${iconHTML}</div>
            <h3>${title}</h3>
            <p>${datos.descripcion}</p>
          </div>
          <div class="guia-modal-body">
            <div class="guia-modal-section">
              <h4><i data-lucide="list-ordered"></i> Pasos a seguir</h4>
              <ul class="guia-modal-steps">
                ${datos.pasos.map((paso, i) => `
                  <li>
                    <span class="step-number">${i + 1}</span>
                    <div class="step-content">
                      <strong>${paso.titulo}</strong>
                      <span>${paso.desc}</span>
                    </div>
                  </li>
                `).join('')}
              </ul>
            </div>
            <div class="guia-modal-section">
              <div class="guia-modal-tip">
                <i data-lucide="lightbulb"></i>
                <p><strong>Tip:</strong> ${datos.tip}</p>
              </div>
            </div>
          </div>
          <div class="guia-modal-footer">
            <div class="guia-modal-tags">${tagsHTML}</div>
            <button class="guia-modal-action" onclick="closeGuiaModal()">
              <i data-lucide="check"></i> Entendido
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    lucide.createIcons();
    document.addEventListener('keydown', handleEscapeKey);
  }

  function handleEscapeKey(e) {
    if (e.key === 'Escape') closeGuiaModal();
  }

  function closeGuiaModal(event) {
    if (event && event.target !== event.currentTarget) return;
    const overlay = document.querySelector('.guia-modal-overlay');
    if (overlay) {
      overlay.classList.remove('active');
      setTimeout(() => overlay.remove(), 300);
    }
    document.removeEventListener('keydown', handleEscapeKey);
  }

  function filterAyudaContent(query) {
    const accordions = document.querySelectorAll('.ayuda-accordion');
    const guiaItems = document.querySelectorAll('.guia-item');
    const noResults = document.getElementById('noResultsMessage');
    const resultsCount = document.getElementById('searchResultsCount');
    let totalVisible = 0;

    if (!query) {
      // Sin b√∫squeda: mostrar todo normal
      accordions.forEach(acc => {
        acc.classList.remove('hidden', 'open');
      });
      guiaItems.forEach(item => {
        item.classList.remove('hidden', 'highlight');
      });
      noResults.classList.remove('visible');
      resultsCount.classList.remove('visible');
      return;
    }

    // Con b√∫squeda: filtrar
    accordions.forEach(accordion => {
      const items = accordion.querySelectorAll('.guia-item');
      let hasVisibleItems = false;

      items.forEach(item => {
        const keywords = item.dataset.keywords || '';
        const title = item.querySelector('h4')?.textContent.toLowerCase() || '';
        const desc = item.querySelector('p')?.textContent.toLowerCase() || '';
        const searchText = keywords + ' ' + title + ' ' + desc;

        if (searchText.includes(query)) {
          item.classList.remove('hidden');
          item.classList.add('highlight');
          hasVisibleItems = true;
          totalVisible++;
        } else {
          item.classList.add('hidden');
          item.classList.remove('highlight');
        }
      });

      if (hasVisibleItems) {
        accordion.classList.remove('hidden');
        accordion.classList.add('open');
      } else {
        accordion.classList.add('hidden');
      }
    });

    // Mostrar mensaje si no hay resultados
    if (totalVisible === 0) {
      noResults.classList.add('visible');
      resultsCount.classList.remove('visible');
    } else {
      noResults.classList.remove('visible');
      resultsCount.textContent = `Se encontraron ${totalVisible} resultado${totalVisible !== 1 ? 's' : ''}`;
      resultsCount.classList.add('visible');
    }
  }

  // Funci√≥n auxiliar para mostrar notificaciones
  function showNotification(message, type = 'success') {
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Funci√≥n para abrir detalle de curso
  window.abrirDetalleCursoAlumno = async function(idCurso, nombreCurso) {
    try {
      loader.classList.remove('hidden');
      
      const id_alumno = localStorage.getItem("id_alumno");
      const response = await fetch(`${API_URL}/cursos/${idCurso}/detalles`);
      const data = await response.json();
      
      // Buscar las calificaciones del alumno actual
      const misCalificaciones = data.alumnos.find(a => a.id_alumno == id_alumno);
      
      // Crear overlay y panel
      const overlay = document.createElement('div');
      overlay.className = 'curso-detalle-overlay active';
      overlay.onclick = cerrarDetalleCursoAlumno;
      
      const panel = document.createElement('div');
      panel.className = 'curso-detalle-panel-alumno active';
      panel.id = 'cursoDetallePanel';
      
      panel.innerHTML = `
        <div class="panel-header-alumno">
          <div>
            <h2>${nombreCurso}</h2>
            <p class="curso-idioma-badge">${data.curso.nombre_idioma || 'Curso'}</p>
          </div>
          <button class="btn-cerrar-panel" onclick="cerrarDetalleCursoAlumno()">
            <i data-lucide="x"></i>
          </button>
        </div>
        
        <div class="panel-body-alumno">
          <div class="info-section">
            <h3><i data-lucide="info"></i> Informaci√≥n del Curso</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Profesor:</span>
                <span class="info-value">${data.curso.profesor || 'No asignado'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Horario:</span>
                <span class="info-value">${data.curso.horario || 'Por confirmar'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Aula:</span>
                <span class="info-value">${data.curso.nombre_aula || 'Por asignar'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Nivel:</span>
                <span class="info-value">${data.curso.nivel || 'N/A'}</span>
              </div>
            </div>
          </div>

          <div class="calificaciones-section">
            <h3><i data-lucide="clipboard-check"></i> Mis Calificaciones</h3>
            ${misCalificaciones ? `
              <div class="calificaciones-detalle">
                <div class="nota-item">
                  <span>Parcial 1:</span>
                  <span class="nota-valor">${misCalificaciones.parcial1 > 0 ? misCalificaciones.parcial1 : 'Pendiente'}</span>
                </div>
                <div class="nota-item">
                  <span>Parcial 2:</span>
                  <span class="nota-valor">${misCalificaciones.parcial2 > 0 ? misCalificaciones.parcial2 : 'Pendiente'}</span>
                </div>
                <div class="nota-item">
                  <span>Final:</span>
                  <span class="nota-valor">${misCalificaciones.final > 0 ? misCalificaciones.final : 'Pendiente'}</span>
                </div>
                ${misCalificaciones.promedio > 0 ? `
                  <div class="nota-item promedio-final">
                    <span>Promedio:</span>
                    <span class="nota-valor destacado">${parseFloat(misCalificaciones.promedio).toFixed(1)}</span>
                  </div>
                ` : ''}
              </div>
            ` : '<p class="sin-datos">A√∫n no hay calificaciones registradas</p>'}
          </div>

          <div class="companeros-section">
            <h3><i data-lucide="users"></i> Compa√±eros de Curso</h3>
            ${data.alumnos && data.alumnos.length > 1 ? `
              <div class="companeros-list">
                ${data.alumnos.filter(a => a.id_alumno != id_alumno).map(alumno => {
                  const iniciales = alumno.nombre_completo.split(' ').map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();
                  let avatarHTML = '';
                  
                  if (alumno.avatar) {
                    const BASE_URL = window.BASE_URL || 'http://localhost:3000';
                    const avatarUrl = alumno.avatar.startsWith('http') ? alumno.avatar : `${BASE_URL}${alumno.avatar}`;
                    avatarHTML = `<img src="${avatarUrl}" alt="${alumno.nombre_completo}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                  } else {
                    avatarHTML = `<i data-lucide="user"></i>`;
                  }
                  
                  return `
                    <div class="companero-item">
                      <div class="companero-avatar">
                        ${avatarHTML}
                      </div>
                      <span>${alumno.nombre_completo}</span>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : '<p class="sin-datos">Eres el √∫nico alumno inscrito en este curso</p>'}
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      document.body.appendChild(panel);
      lucide.createIcons();
      loader.classList.add('hidden');
      
    } catch (error) {
      console.error('Error al cargar detalles:', error);
      loader.classList.add('hidden');
      showNotification('Error al cargar los detalles del curso', 'error');
    }
  };

  window.cerrarDetalleCursoAlumno = function() {
    const overlay = document.querySelector('.curso-detalle-overlay');
    const panel = document.getElementById('cursoDetallePanel');
    
    if (overlay) overlay.remove();
    if (panel) panel.remove();
  };

  // Funci√≥n para ver detalle de calificaci√≥n (desde tabla)
  window.verDetalleCalificacion = function(idCurso, nombreCurso) {
    abrirDetalleCursoAlumno(idCurso, nombreCurso);
  };

  // Modal de selecci√≥n de mes (NUEVO SISTEMA DE PAGOS)
  window.abrirModalSeleccionMes = function(idCurso, nombreCurso, mesSeleccionado, monto) {
    const modal = document.createElement('div');
    modal.className = 'modal-seleccion-mes-overlay active';
    modal.id = 'modalSeleccionMes';
    
    modal.innerHTML = `
      <div class="modal-seleccion-mes-content">
        <div class="modal-seleccion-mes-header">
          <div class="header-info">
            <i data-lucide="calendar"></i>
            <div>
              <h3>Confirmar Pago</h3>
              <p>${nombreCurso}</p>
            </div>
          </div>
          <button class="btn-cerrar-modal" onclick="cerrarModalSeleccionMes()">
            <i data-lucide="x"></i>
          </button>
        </div>
        
        <div class="modal-seleccion-mes-body">
          <div class="mes-confirmacion">
            <div class="mes-icono">
              <i data-lucide="check-circle"></i>
            </div>
            <div class="mes-detalle">
              <span class="mes-label">Cuota de:</span>
              <span class="mes-valor">${mesSeleccionado}</span>
            </div>
          </div>
          
          <div class="monto-confirmacion">
            <span class="monto-label">Monto a pagar:</span>
            <span class="monto-valor">$${parseFloat(monto).toLocaleString('es-AR', {minimumFractionDigits: 2})}</span>
          </div>
          
          <div class="acciones-confirmacion">
            <button class="btn-cancelar" onclick="cerrarModalSeleccionMes()">
              <i data-lucide="x"></i>
              Cancelar
            </button>
            <button class="btn-confirmar-pago" onclick="confirmarPagoMes(${idCurso}, '${mesSeleccionado}', ${monto})">
              <i data-lucide="credit-card"></i>
              Continuar al Pago
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    lucide.createIcons();
    
    // Cerrar al hacer clic fuera del modal
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        cerrarModalSeleccionMes();
      }
    });
  };

  window.cerrarModalSeleccionMes = function() {
    const modal = document.getElementById('modalSeleccionMes');
    if (modal) {
      modal.classList.remove('active');
      setTimeout(() => modal.remove(), 300);
    }
  };

  window.confirmarPagoMes = function(idCurso, mesCuota, monto) {
    // Cerrar modal de selecci√≥n
    cerrarModalSeleccionMes();
    
    // Guardar datos del pago para enviar despu√©s
    window.datosPagoActual = {
      id_curso: idCurso,
      mes_cuota: mesCuota,
      monto: monto
    };
    
    // Determinar el concepto correcto
    const conceptoPago = mesCuota === 'Matricula' ? 'Matricula' : `Cuota ${mesCuota}`;
    
    // Abrir el modal de m√©todos de pago existente
    window.creditCardForm.openModal({
      amount: monto,
      concepto: conceptoPago,
      periodo: mesCuota,
      id_curso: idCurso
    });
  };

  // Funci√≥n para abrir modal de pago
  window.abrirModalPago = function(periodo, monto, mesNombre) {
    const modal = document.createElement('div');
    modal.className = 'modal-pago-overlay active';
    modal.id = 'modalPago';
    
    modal.innerHTML = `
      <div class="modal-pago-content">
        <div class="modal-pago-header">
          <h2><i data-lucide="credit-card"></i> Realizar Pago</h2>
          <button class="btn-cerrar-modal" onclick="cerrarModalPago()">
            <i data-lucide="x"></i>
          </button>
        </div>
        
        <div class="modal-pago-body">
          <div class="info-pago-detalle">
            <div class="info-row">
              <span class="info-label">Per√≠odo:</span>
              <span class="info-valor">${mesNombre}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Monto a pagar:</span>
              <span class="info-valor monto-destacado">$${parseFloat(monto).toLocaleString('es-AR', {minimumFractionDigits: 2})}</span>
            </div>
          </div>

          <div class="metodo-pago-selector">
            <label><i data-lucide="credit-card"></i> Selecciona el medio de pago:</label>
            <div class="metodos-pago-grid">
              <div class="metodo-option" data-metodo="Tarjeta de Cr√©dito">
                <i data-lucide="credit-card"></i>
                <span>Tarjeta de Cr√©dito</span>
              </div>
              <div class="metodo-option" data-metodo="Tarjeta de D√©bito">
                <i data-lucide="credit-card"></i>
                <span>Tarjeta de D√©bito</span>
              </div>
              <div class="metodo-option" data-metodo="Transferencia">
                <i data-lucide="arrow-right-left"></i>
                <span>Transferencia</span>
              </div>
              <div class="metodo-option" data-metodo="Efectivo">
                <i data-lucide="banknote"></i>
                <span>Efectivo</span>
              </div>
            </div>
          </div>

          <div id="formularioTarjeta" class="formulario-tarjeta" style="display: none;">
            <h4><i data-lucide="credit-card"></i> Datos de la Tarjeta</h4>
            
            <div class="form-group">
              <label>N√∫mero de Tarjeta</label>
              <input type="text" id="numeroTarjeta" placeholder="1234 5678 9012 3456" maxlength="19" 
                     oninput="formatearNumeroTarjeta(this)">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Titular</label>
                <input type="text" id="titularTarjeta" placeholder="NOMBRE APELLIDO">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Vencimiento (MM/AA)</label>
                <input type="text" id="vencimientoTarjeta" placeholder="MM/AA" maxlength="5"
                       oninput="formatearVencimiento(this)">
              </div>
              <div class="form-group">
                <label>CVV</label>
                <input type="text" id="cvvTarjeta" placeholder="123" maxlength="4"
                       oninput="this.value=this.value.replace(/[^0-9]/g,'')">
              </div>
            </div>
          </div>

          <button class="btn-confirmar-pago" onclick="procesarPago('${periodo}', ${monto})">
            <i data-lucide="check-circle"></i>
            <span>Confirmar Pago</span>
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    lucide.createIcons();
    
    // Agregar event listeners a las opciones de pago DESPU√âS de crear el modal
    const opciones = modal.querySelectorAll('.metodo-option');
    console.log(' Opciones de pago encontradas:', opciones.length);
    
    opciones.forEach((opcion, index) => {
      const metodo = opcion.getAttribute('data-metodo');
      console.log(` Agregando listener ${index + 1}: ${metodo}`);
      
      opcion.addEventListener('click', function() {
        console.log(' Click detectado en:', metodo);
        window.seleccionarMetodo(this, metodo);
      });
    });
  };

  window.cerrarModalPago = function() {
    const modal = document.getElementById('modalPago');
    if (modal) modal.remove();
  };

  let medioPagoSeleccionado = null;

  window.seleccionarMetodo = function(elemento, metodo) {
    console.log(' seleccionarMetodo llamado con:', metodo);
    
    // Si es efectivo, cerrar modal de pago y mostrar ticket inmediatamente
    if (metodo === 'Efectivo') {
      console.log(' Detectado pago en efectivo');
      
      // Cerrar el modal de pago primero
      const modal = document.getElementById('modalPago');
      if (modal) {
        modal.remove();
        console.log('Ô∏è Modal de pago cerrado');
      }
      
      // Peque√±o delay para asegurar que el modal se cerr√≥ completamente
      setTimeout(() => {
        console.log(' Mostrando ticket de efectivo...');
        window.mostrarTicketEfectivo();
      }, 100);
      
      return;
    }
    
    // Remover selecci√≥n anterior
    document.querySelectorAll('.metodo-option').forEach(el => el.classList.remove('selected'));
    
    // Marcar como seleccionado
    elemento.classList.add('selected');
    medioPagoSeleccionado = metodo;
    
    // Mostrar/ocultar formulario de tarjeta
    const formulario = document.getElementById('formularioTarjeta');
    if (metodo.includes('Tarjeta')) {
      formulario.style.display = 'block';
    } else {
      formulario.style.display = 'none';
    }
  };

  // Funci√≥n para generar y mostrar ticket de efectivo
  window.mostrarTicketEfectivo = function() {
    console.log(' INICIO mostrarTicketEfectivo');
    
    // Generar n√∫mero de ticket aleatorio (12 d√≠gitos)
    const numeroTicket = Math.floor(100000000000 + Math.random() * 900000000000);
    console.log(' Ticket generado:', numeroTicket);
    
    // Crear modal HTML nativo
    const modalTicket = document.createElement('div');
    modalTicket.className = 'modal-pago-overlay active';
    modalTicket.id = 'modalTicket';
    modalTicket.style.zIndex = '10000';
    
    modalTicket.innerHTML = `
      <div class="modal-pago-content" style="max-width: 500px;">
        <div class="modal-pago-header" style="background: #4a5259;">
          <h2 style="color: white;"><i data-lucide="banknote"></i> Pago en Efectivo</h2>
          <button class="btn-cerrar-modal" onclick="cerrarModalTicket()" style="color: white;">
            <i data-lucide="x"></i>
          </button>
        </div>
        
        <div class="modal-pago-body" style="text-align: center; padding: 30px;">
          <div style="background: #4a5259; color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; position: relative;">
            <button onclick="descargarTicketPDF('${numeroTicket}')" 
                    style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; backdrop-filter: blur(10px);" 
                    onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.05)'" 
                    onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'" 
                    title="Descargar Ticket PDF">
              <i data-lucide="download" style="width: 20px; height: 20px;"></i>
            </button>
            <p style="margin: 0 0 15px 0; font-size: 16px; opacity: 0.9; font-weight: 500;">
              Tu n√∫mero de ticket es
            </p>
            <p style="margin: 0; font-size: 36px; font-weight: 700; letter-spacing: 3px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
              N¬∫ ${numeroTicket}
            </p>
          </div>
          
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #4a5259; margin-bottom: 20px;">
            <p style="margin: 0; color: #333; line-height: 1.8; font-size: 15px;">
              <strong style="color: #4a5259;"> Acercate a una de nuestras oficinas</strong><br>
              <span style="color: #666;">Lunes a Viernes de 7:00 a 14:00 hs</span>
            </p>
          </div>
          
          <button onclick="cerrarModalTicket()" style="background: #4a5259; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
            Entendido
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modalTicket);
    lucide.createIcons();
    
    console.log(' Modal de ticket creado y mostrado');
  };
  
  window.cerrarModalTicket = function() {
    const modal = document.getElementById('modalTicket');
    if (modal) {
      modal.remove();
      console.log('Ô∏è Modal de ticket cerrado');
    }
  };

  // Funci√≥n para descargar ticket de pago en efectivo como PDF
  window.descargarTicketPDF = async function(numeroTicket) {
    try {
      const { jsPDF } = window.jspdf;
      
      // Crear PDF en formato ticket (80mm de ancho)
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: [80, 150] // Ticket t√©rmico
      });
      
      let yPos = 15;
      
      // Logo
      const img = new Image();
      img.src = '/images/logo.png';
      await new Promise((resolve) => {
        img.onload = () => {
          doc.addImage(img, 'PNG', 25, yPos, 30, 30);
          resolve();
        };
        img.onerror = resolve;
      });
      
      yPos += 35;
      
      // T√≠tulo CEMI
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text('CEMI', 40, yPos, { align: 'center' });
      yPos += 5;
      
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text('Sistema Educativo', 40, yPos, { align: 'center' });
      yPos += 10;
      
      // L√≠nea separadora
      doc.setDrawColor(30, 60, 114);
      doc.setLineWidth(0.5);
      doc.line(10, yPos, 70, yPos);
      yPos += 8;
      
      // T√≠tulo del ticket
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(30, 60, 114);
      doc.text('TICKET DE PAGO', 40, yPos, { align: 'center' });
      yPos += 6;
      
      doc.setFontSize(12);
      doc.setTextColor(0);
      doc.text('Pago en Efectivo', 40, yPos, { align: 'center' });
      yPos += 10;
      
      // L√≠nea separadora
      doc.setDrawColor(200);
      doc.setLineWidth(0.3);
      doc.line(10, yPos, 70, yPos);
      yPos += 8;
      
      // N√∫mero de ticket (destacado)
      doc.setFillColor(30, 60, 114);
      doc.roundedRect(10, yPos, 60, 18, 3, 3, 'F');
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(255, 255, 255);
      doc.text('Tu n√∫mero de ticket es', 40, yPos + 5, { align: 'center' });
      
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text(`N¬∫ ${numeroTicket}`, 40, yPos + 13, { align: 'center' });
      yPos += 24;
      
      // Fecha y hora
      doc.setTextColor(0);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      const ahora = new Date();
      const fecha = ahora.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      const hora = ahora.toLocaleTimeString('es-ES', {
        hour: '2-digit',
        minute: '2-digit'
      });
      doc.text(`Generado: ${fecha} - ${hora}`, 40, yPos, { align: 'center' });
      yPos += 8;
      
      // L√≠nea separadora
      doc.line(10, yPos, 70, yPos);
      yPos += 6;
      
      // Instrucciones
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(30, 60, 114);
      doc.text('INSTRUCCIONES DE PAGO', 40, yPos, { align: 'center' });
      yPos += 6;
      
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(0);
      
      const instrucciones = [
        '1. Acercate a nuestras oficinas',
        '2. Present√° este ticket',
        '3. Realiz√° el pago en efectivo',
        '4. Recibir√°s tu comprobante'
      ];
      
      instrucciones.forEach((linea) => {
        doc.text(linea, 12, yPos);
        yPos += 4;
      });
      yPos += 2;
      
      // Horarios
      doc.setFillColor(248, 249, 250);
      doc.roundedRect(10, yPos, 60, 12, 2, 2, 'F');
      
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(30, 60, 114);
      doc.text(' Horario de Atenci√≥n', 40, yPos + 4, { align: 'center' });
      
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(100);
      doc.text('Lunes a Viernes', 40, yPos + 8, { align: 'center' });
      doc.text('7:00 a 14:00 hs', 40, yPos + 11, { align: 'center' });
      yPos += 18;
      
      // Footer
      doc.setDrawColor(200);
      doc.line(10, yPos, 70, yPos);
      yPos += 4;
      
      doc.setFontSize(7);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(150);
      doc.text('Conserv√° este ticket hasta completar el pago', 40, yPos, { align: 'center' });
      yPos += 3;
      doc.text('www.cemi-educativo.com', 40, yPos, { align: 'center' });
      
      // Descargar PDF
      doc.save(`Ticket-Pago-Efectivo-${numeroTicket}.pdf`);
      
      console.log(' Ticket PDF generado correctamente');
      
      // Mostrar notificaci√≥n
      Swal.fire({
        icon: 'success',
        title: 'Ticket Descargado',
        text: 'Tu ticket se ha descargado correctamente',
        timer: 2000,
        showConfirmButton: false
      });
      
    } catch (error) {
      console.error(' Error al generar ticket PDF:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'No se pudo generar el ticket PDF'
      });
    }
  };

  window.formatearNumeroTarjeta = function(input) {
    let valor = input.value.replace(/\s/g, '');
    valor = valor.replace(/[^0-9]/g, '');
    let formateado = valor.match(/.{1,4}/g)?.join(' ') || valor;
    input.value = formateado;
  };

  window.formatearVencimiento = function(input) {
    let valor = input.value.replace(/\//g, '');
    valor = valor.replace(/[^0-9]/g, '');
    if (valor.length >= 2) {
      valor = valor.substring(0, 2) + '/' + valor.substring(2, 4);
    }
    input.value = valor;
  };

  window.procesarPago = async function(periodo, monto) {
    if (!medioPagoSeleccionado) {
      showNotification('Por favor selecciona un medio de pago', 'error');
      return;
    }

    // Validar datos de tarjeta si es necesario
    if (medioPagoSeleccionado.includes('Tarjeta')) {
      const numeroTarjeta = document.getElementById('numeroTarjeta').value;
      const titular = document.getElementById('titularTarjeta').value;
      const vencimiento = document.getElementById('vencimientoTarjeta').value;
      const cvv = document.getElementById('cvvTarjeta').value;

      if (!numeroTarjeta || !titular || !vencimiento || !cvv) {
        showNotification('Por favor completa todos los datos de la tarjeta', 'error');
        return;
      }

      if (numeroTarjeta.replace(/\s/g, '').length < 15) {
        showNotification('N√∫mero de tarjeta inv√°lido', 'error');
        return;
      }

      if (cvv.length < 3) {
        showNotification('CVV inv√°lido', 'error');
        return;
      }
    }

    try {
      loader.classList.remove('hidden');
      
      // Obtener datos del pago actual (id_curso y mes_cuota)
      const datosPago = window.datosPagoActual || {};
      
      const response = await fetch(`${API_URL}/pagos/realizar`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          id_alumno: id_alumno,
          id_curso: datosPago.id_curso,
          mes_cuota: datosPago.mes_cuota || periodo,
          monto: monto,
          medio_pago: medioPagoSeleccionado,
          datos_tarjeta: medioPagoSeleccionado.includes('Tarjeta') ? {
            numero: document.getElementById('numeroTarjeta')?.value,
            titular: document.getElementById('titularTarjeta')?.value,
            vencimiento: document.getElementById('vencimientoTarjeta')?.value
          } : null
        })
      });

      const data = await response.json();

      if (response.ok && data.success) {
        loader.classList.add('hidden');
        cerrarModalPago();
        
        // Limpiar datos temporales
        window.datosPagoActual = null;
        
        // Mostrar comprobante
        mostrarComprobante(data.comprobante);
        
        // Recargar la secci√≥n de pagos
        setTimeout(() => {
          document.getElementById('btnPagos').click();
        }, 3000);
      } else {
        throw new Error(data.message || 'Error al procesar el pago');
      }
    } catch (error) {
      console.error('Error al procesar pago:', error);
      loader.classList.add('hidden');
      showNotification(error.message || 'Error al procesar el pago', 'error');
    }
  };

  window.mostrarComprobante = function(comprobante) {
    const modal = document.createElement('div');
    modal.className = 'modal-pago-overlay active';
    modal.id = 'modalComprobante';
    
    modal.innerHTML = `
      <div class="modal-comprobante-content">
        <div class="comprobante-header">
          <div class="check-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <h2>¬°Pago Exitoso!</h2>
          <p>Tu pago ha sido procesado correctamente</p>
        </div>
        
        <div class="comprobante-body">
          <div class="comprobante-detalle">
            <div class="detalle-row">
              <span>Comprobante N¬∞:</span>
              <strong>${comprobante.numero}</strong>
            </div>
            <div class="detalle-row">
              <span>Fecha:</span>
              <strong>${new Date(comprobante.fecha).toLocaleDateString('es-ES')}</strong>
            </div>
            <div class="detalle-row">
              <span>Per√≠odo:</span>
              <strong>${new Date(comprobante.periodo + '-01').toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}</strong>
            </div>
            <div class="detalle-row total">
              <span>Monto Pagado:</span>
              <strong>$${parseFloat(comprobante.monto).toLocaleString('es-AR', {minimumFractionDigits: 2})}</strong>
            </div>
          </div>
        </div>
        
        <button class="btn-cerrar-comprobante" onclick="cerrarComprobante()">
          <i data-lucide="x"></i>
          Cerrar
        </button>
      </div>
    `;
    
    document.body.appendChild(modal);
    lucide.createIcons();
  };

  window.cerrarComprobante = function() {
    const modal = document.getElementById('modalComprobante');
    if (modal) modal.remove();
  };

  // Navegaci√≥n SPA con logout
  document.querySelectorAll(".sidebar-menu button").forEach(btn => {
    btn.addEventListener("click", () => {
      if (btn.id === "logoutBtn") {
        localStorage.clear();
        window.location.href = "login.html";
        return;
      }

      document.querySelectorAll(".sidebar-menu button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      loader.classList.remove("hidden");
      mainContent.classList.remove("active");

      setTimeout(() => {
        sections[btn.id]?.();
      }, 250);
    });
  });

  // Cargar "Mis Cursos" por defecto al iniciar
  document.addEventListener("DOMContentLoaded", () => {
    const btnCursos = document.getElementById("btnCursos");
    if (btnCursos) {
      btnCursos.classList.add("active");
      btnCursos.click();
    }
  });
</script>

<div class="payment-method-modal-overlay" id="paymentMethodModal" onclick="if(event.target === this) this.classList.remove('active')">
  <div class="payment-method-modal">
    <div class="payment-method-header">
      <h2><i data-lucide="wallet"></i> Seleccionar M√©todo de Pago</h2>
      <button class="payment-close" onclick="document.getElementById('paymentMethodModal').classList.remove('active')">
        <i data-lucide="x"></i>
      </button>
    </div>

    <div class="payment-info-summary">
      <div class="payment-info-row">
        <span class="payment-info-label">Concepto:</span>
        <span class="payment-info-value" id="methodPaymentConcepto">Cuota Mensual</span>
      </div>
      <div class="payment-info-row">
        <span class="payment-info-label">Per√≠odo:</span>
        <span class="payment-info-value" id="methodPaymentPeriodo">-</span>
      </div>
      <div class="payment-info-row">
        <span class="payment-info-label">Monto a Pagar:</span>
        <span class="payment-info-value payment-amount-highlight" id="methodPaymentAmount">$0.00</span>
      </div>
    </div>

    <div class="payment-methods-grid">
      <button class="payment-method-option" id="btnCardPayment">
        <div class="payment-method-icon">
          <i data-lucide="credit-card"></i>
        </div>
        <div>
          <h3>Tarjeta de Cr√©dito/D√©bito</h3>
          <p>Pago instant√°neo con tarjeta</p>
        </div>
      </button>

      <button class="payment-method-option" id="btnTransferPayment" onclick="document.getElementById('paymentMethodModal').classList.remove('active'); document.getElementById('transferModal').classList.add('active'); if(typeof lucide !== 'undefined') lucide.createIcons();">
        <div class="payment-method-icon">
          <i data-lucide="landmark"></i>
        </div>
        <div>
          <h3>Transferencia Bancaria</h3>
          <p>Transferir desde tu banco</p>
        </div>
      </button>

      <button class="payment-method-option" id="btnCashPayment">
        <div class="payment-method-icon">
          <i data-lucide="banknote"></i>
        </div>
        <div>
          <h3>Efectivo</h3>
          <p>Pagar en la instituci√≥n</p>
        </div>
      </button>
    </div>
  </div>
</div>

<div class="credit-card-modal-overlay" id="creditCardModal">
  <div class="credit-card-modal">
    <div class="modal-header">
      <h2>Pago con Tarjeta</h2>
      <div class="modal-actions">
        <button class="back-button" id="backToMethods">‚Üê</button>
        <button class="close-button" id="closePaymentModal">√ó</button>
      </div>
    </div>

    <input type="hidden" id="paymentIdPago" value="">
    <input type="hidden" id="paymentConcepto" value="">
    <input type="hidden" id="paymentPeriodo" value="">
    <input type="hidden" id="paymentAmount" data-amount="0">

    <div class="payment-content-wrapper">
      <div class="container preload">
        <div class="creditcard">
          <div class="front">
            <div id="ccsingle"></div>
            <svg version="1.1" id="cardfront" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px" y="0px" viewBox="0 0 750 471" style="enable-background:new 0 0 750 471;" xml:space="preserve">
                <g id="Front">
                    <g id="CardBackground">
                        <g id="Page-1_1_">
                            <g id="amex_1_">
                                <path id="Rectangle-1_1_" class="lightcolor grey" d="M40,0h670c22.1,0,40,17.9,40,40v391c0,22.1-17.9,40-40,40H40c-22.1,0-40-17.9-40-40V40
                        C0,17.9,17.9,0,40,0z" />
                            </g>
                        </g>
                        <path class="darkcolor greydark" d="M750,431V193.2c-217.6-57.5-556.4-13.5-750,24.9V431c0,22.1,17.9,40,40,40h670C732.1,471,750,453.1,750,431z" />
                    </g>
                    <text transform="matrix(1 0 0 1 60.106 295.0121)" id="svgnumber" class="st2 st3 st4">0123 4567 8910 1112</text>
                    <text transform="matrix(1 0 0 1 54.1064 428.1723)" id="svgname" class="st2 st5 st6">JUAN P√âREZ</text>
                    <text transform="matrix(1 0 0 1 54.1074 389.8793)" class="st7 st5 st8">nombre del titular</text>
                    <text transform="matrix(1 0 0 1 479.7754 388.8793)" class="st7 st5 st8">vencimiento</text>
                    <text transform="matrix(1 0 0 1 65.1054 241.5)" class="st7 st5 st8">n√∫mero de tarjeta</text>
                    <g>
                        <text transform="matrix(1 0 0 1 574.4219 433.8095)" id="svgexpire" class="st2 st5 st9">01/23</text>
                        <text transform="matrix(1 0 0 1 479.3848 417.0097)" class="st2 st10 st11">V√ÅLIDO</text>
                        <text transform="matrix(1 0 0 1 479.3848 435.6762)" class="st2 st10 st11">HASTA</text>
                        <polygon class="st2" points="554.5,421 540.4,414.2 540.4,427.9 		" />
                    </g>
                    <g id="cchip">
                        <g>
                            <path class="st2" d="M168.1,143.6H82.9c-10.2,0-18.5-8.3-18.5-18.5V74.9c0-10.2,8.3-18.5,18.5-18.5h85.3
                    c10.2,0,18.5,8.3,18.5,18.5v50.2C186.6,135.3,178.3,143.6,168.1,143.6z" />
                        </g>
                        <g>
                            <g>
                                <rect x="82" y="70" class="st12" width="1.5" height="60" />
                            </g>
                            <g>
                                <rect x="167.4" y="70" class="st12" width="1.5" height="60" />
                            </g>
                            <g>
                                <path class="st12" d="M125.5,130.8c-10.2,0-18.5-8.3-18.5-18.5c0-4.6,1.7-8.9,4.7-12.3c-3-3.4-4.7-7.7-4.7-12.3
                        c0-10.2,8.3-18.5,18.5-18.5s18.5,8.3,18.5,18.5c0,4.6-1.7,8.9-4.7,12.3c3,3.4,4.7,7.7,4.7,12.3
                        C143.9,122.5,135.7,130.8,125.5,130.8z M125.5,70.8c-9.3,0-16.9,7.6-16.9,16.9c0,4.4,1.7,8.6,4.8,11.8l0.5,0.5l-0.5,0.5
                        c-3.1,3.2-4.8,7.4-4.8,11.8c0,9.3,7.6,16.9,16.9,16.9s16.9-7.6,16.9-16.9c0-4.4-1.7-8.6-4.8-11.8l-0.5-0.5l0.5-0.5
                        c3.1-3.2,4.8-7.4,4.8-11.8C142.4,78.4,134.8,70.8,125.5,70.8z" />
                            </g>
                            <g>
                                <rect x="82.8" y="82.1" class="st12" width="25.8" height="1.5" />
                            </g>
                            <g>
                                <rect x="82.8" y="117.9" class="st12" width="26.1" height="1.5" />
                            </g>
                            <g>
                                <rect x="142.4" y="82.1" class="st12" width="25.8" height="1.5" />
                            </g>
                            <g>
                                <rect x="142" y="117.9" class="st12" width="26.2" height="1.5" />
                            </g>
                        </g>
                    </g>
                </g>
                <g id="Back">
                </g>
            </svg>
          </div>
          <div class="back">
            <svg version="1.1" id="cardback" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px" y="0px" viewBox="0 0 750 471" style="enable-background:new 0 0 750 471;" xml:space="preserve">
                <g id="Front">
                    <line class="st0" x1="35.3" y1="10.4" x2="36.7" y2="11" />
                </g>
                <g id="Back">
                    <g id="Page-1_2_">
                        <g id="amex_2_">
                            <path id="Rectangle-1_2_" class="darkcolor greydark" d="M40,0h670c22.1,0,40,17.9,40,40v391c0,22.1-17.9,40-40,40H40c-22.1,0-40-17.9-40-40V40
                    C0,17.9,17.9,0,40,0z" />
                        </g>
                    </g>
                    <rect y="61.6" class="st2" width="750" height="78" />
                    <g>
                        <path class="st3" d="M701.1,249.1H48.9c-3.3,0-6-2.7-6-6v-52.5c0-3.3,2.7-6,6-6h652.1c3.3,0,6,2.7,6,6v52.5
                C707.1,246.4,704.4,249.1,701.1,249.1z" />
                        <rect x="42.9" y="198.6" class="st4" width="664.1" height="10.5" />
                        <rect x="42.9" y="224.5" class="st4" width="664.1" height="10.5" />
                        <path class="st5" d="M701.1,184.6H618h-8h-10v64.5h10h8h83.1c3.3,0,6-2.7,6-6v-52.5C707.1,187.3,704.4,184.6,701.1,184.6z" />
                    </g>
                    <text transform="matrix(1 0 0 1 621.999 227.2734)" id="svgsecurity" class="st6 st7">985</text>
                    <g class="st8">
                        <text transform="matrix(1 0 0 1 518.083 280.0879)" class="st9 st6 st10">c√≥digo de seguridad</text>
                    </g>
                    <rect x="58.1" y="378.6" class="st11" width="375.5" height="13.5" />
                    <rect x="58.1" y="405.6" class="st11" width="421.7" height="13.5" />
                    <text transform="matrix(1 0 0 1 59.5073 228.6099)" id="svgnameback" class="st12 st13">Juan P√©rez</text>
                </g>
            </svg>
          </div>
        </div>
      </div>

      <form class="form-container" id="creditCardForm">
        <div class="field-container">
          <label for="name">Nombre del Titular</label>
          <input id="name" maxlength="20" type="text" placeholder="JUAN P√âREZ">
        </div>
        <div class="field-container">
          <label for="cardnumber">N√∫mero de Tarjeta</label><span id="generatecard">generar aleatorio</span>
          <input id="cardnumber" type="text" pattern="[0-9]*" inputmode="numeric" placeholder="1234 5678 9012 3456">
          <svg id="ccicon" class="ccicon" width="750" height="471" viewBox="0 0 750 471" version="1.1" xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink">
          </svg>
        </div>
        <div class="field-container">
          <label for="expirationdate">Vencimiento (mm/aa)</label>
          <input id="expirationdate" type="text" pattern="[0-9]*" inputmode="numeric" placeholder="01/25">
        </div>
        <div class="field-container">
          <label for="securitycode">C√≥digo de Seguridad</label>
          <input id="securitycode" type="text" pattern="[0-9]*" inputmode="numeric" placeholder="123">
        </div>
      </form>
    </div> <!-- cierre payment-content-wrapper -->
  </div> <!-- cierre credit-card-modal -->
</div> <!-- cierre credit-card-modal-overlay -->

<div class="transfer-modal-overlay" id="transferModal" onclick="if(event.target === this) this.classList.remove('active')">
  <div class="transfer-modal">
    <div class="transfer-header">
      <h2><i data-lucide="landmark"></i> Datos para Transferencia</h2>
      <button class="transfer-close" onclick="document.getElementById('transferModal').classList.remove('active')">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div class="transfer-content">
      <div class="transfer-info-card">
        <div class="transfer-field">
          <label>Alias</label>
          <div class="transfer-value">
            <span>educacion.cemi</span>
            <button class="copy-btn" onclick="copyToClipboard('educacion.cemi', this)">
              <i data-lucide="copy"></i>
            </button>
          </div>
        </div>
        <div class="transfer-field">
          <label>CBU</label>
          <div class="transfer-value">
            <span>0008466199055723490</span>
            <button class="copy-btn" onclick="copyToClipboard('0008466199055723490', this)">
              <i data-lucide="copy"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="transfer-instructions">
        <p><i data-lucide="info"></i> Realiza la transferencia y env√≠a el comprobante por correo o WhatsApp.</p>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/imask"></script>
<script src="assets/js/credit-card.js"></script>

<style>
  .user-chat-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 160px);
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .user-chat-header {
    background: #4a5259;
    color: white;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .user-chat-header h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }

  .user-chat-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    opacity: 0.9;
    margin-top: 4px;
  }

  .user-chat-status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4ade80;
    animation: pulse 2s infinite;
  }

  .user-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .user-chat-message {
    display: flex;
    gap: 10px;
    animation: messageSlideIn 0.3s ease-out;
  }

  .user-chat-message.sent {
    flex-direction: row-reverse;
  }

  .user-chat-message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
    flex-shrink: 0;
  }

  .user-chat-message.sent .user-chat-message-avatar {
    background: #4a5259;
  }

  .user-chat-message.received .user-chat-message-avatar {
    background: #6b7280;
  }

  .user-chat-message-content {
    max-width: 60%;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .user-chat-message-bubble {
    padding: 12px 16px;
    border-radius: 16px;
    word-wrap: break-word;
    white-space: pre-wrap;
  }

  .user-chat-message.sent .user-chat-message-bubble {
    background: #4a5259;
    color: white;
    border-bottom-right-radius: 4px;
  }

  .user-chat-message.received .user-chat-message-bubble {
    background: white;
    color: #333;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .user-chat-message-time {
    font-size: 11px;
    color: #999;
    padding: 0 4px;
  }

  .user-chat-message.sent .user-chat-message-time {
    text-align: right;
  }

  .user-chat-input-area {
    padding: 16px 20px;
    background: white;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .user-chat-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 24px;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    outline: none;
    transition: all 0.3s ease;
  }

  .user-chat-input:focus {
    border-color: #4a5259;
    box-shadow: 0 0 0 3px rgba(74, 82, 89, 0.1);
  }

  .user-chat-send-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #4a5259;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .user-chat-send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(74, 82, 89, 0.4);
  }

  .user-chat-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: scale(1);
  }

  .user-chat-typing {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: rgba(74, 82, 89, 0.1);
    border-radius: 16px;
    font-size: 13px;
    color: #4a5259;
    align-self: flex-start;
  }

  .user-chat-typing-dots {
    display: flex;
    gap: 4px;
  }

  .user-chat-typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #4a5259;
    animation: typingBounce 1.4s infinite;
  }

  .user-chat-typing-dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .user-chat-typing-dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  .user-chat-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #999;
    gap: 12px;
  }

  .user-chat-empty i {
    width: 64px;
    height: 64px;
    opacity: 0.5;
  }

  @keyframes messageSlideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes typingBounce {
    0%, 60%, 100% {
      transform: translateY(0);
    }
    30% {
      transform: translateY(-8px);
    }
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
</style>

  <script>
    // Funcionalidad del men√∫ mobile
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const dashboardMain = document.querySelector('.dashboard-main');
      
      // Solo colapsar sidebar en m√≥viles (<=768px)
      if (window.innerWidth <= 768) {
        sidebar.classList.add('collapsed');
      }    if (mobileMenuToggle && sidebar && sidebarOverlay) {
      // Abrir/cerrar sidebar
      mobileMenuToggle.addEventListener('click', function() {
        sidebar.classList.toggle('collapsed');
        sidebarOverlay.classList.toggle('active');
        if (dashboardMain) {
          dashboardMain.classList.toggle('sidebar-open');
        }
        
        // Cambiar icono
        const icon = this.querySelector('i');
        if (!sidebar.classList.contains('collapsed')) {
          icon.setAttribute('data-lucide', 'x');
        } else {
          icon.setAttribute('data-lucide', 'menu');
        }
        lucide.createIcons();
      });
      
      // Cerrar sidebar al hacer clic en overlay
      sidebarOverlay.addEventListener('click', function() {
        sidebar.classList.add('collapsed');
        sidebarOverlay.classList.remove('active');
        if (dashboardMain) {
          dashboardMain.classList.remove('sidebar-open');
        }
        
        const icon = mobileMenuToggle.querySelector('i');
        icon.setAttribute('data-lucide', 'menu');
        lucide.createIcons();
      });
    }
  });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
async function generarComprobantePago(idPago) {
  try {
    const { jsPDF } = window.jspdf;
    
    // Obtener datos del pago
    const response = await fetch(`${API_URL}/pagos/${idPago}`);
    const pago = await response.json();
    
    if (!pago || !pago.id_pago) {
      throw new Error('No se encontr√≥ el pago');
    }
    
    // Crear PDF en formato ticket (m√°s angosto)
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: [80, 200] // Ancho de ticket t√©rmico
    });
    
    let yPos = 15;
    
    // Logo (m√°s peque√±o para ticket)
    const img = new Image();
    img.src = '/images/logo.png';
    await new Promise((resolve) => {
      img.onload = () => {
        doc.addImage(img, 'PNG', 25, yPos, 30, 30);
        resolve();
      };
      img.onerror = resolve;
    });
    
    yPos += 35;
    
    // T√≠tulo
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('COMPROBANTE DE PAGO', 40, yPos, { align: 'center' });
    yPos += 8;
    
    // L√≠nea separadora
    doc.setDrawColor(200);
    doc.line(10, yPos, 70, yPos);
    yPos += 8;
    
    // N√∫mero de comprobante
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('N¬∞ Comprobante:', 40, yPos, { align: 'center' });
    yPos += 5;
    doc.setFontSize(14);
    doc.setTextColor(25, 118, 210);
    doc.text(`#${String(pago.id_pago).padStart(6, '0')}`, 40, yPos, { align: 'center' });
    doc.setTextColor(0);
    yPos += 10;
    
    // Fecha
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text(`Fecha: ${new Date(pago.fecha_pago).toLocaleDateString('es-ES', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    })}`, 40, yPos, { align: 'center' });
    yPos += 10;
    
    // L√≠nea separadora
    doc.line(10, yPos, 70, yPos);
    yPos += 5;
    
    // Informaci√≥n del alumno
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('DATOS DEL ALUMNO', 40, yPos, { align: 'center' });
    yPos += 5;
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    doc.text('Alumno:', 12, yPos);
    doc.setFont('helvetica', 'bold');
    const nombreLines = doc.splitTextToSize(pago.alumno || '-', 46);
    doc.text(nombreLines, 68, yPos, { align: 'right' });
    yPos += nombreLines.length * 3.5 + 1;
    
    doc.setFont('helvetica', 'normal');
    doc.text('Legajo:', 12, yPos);
    doc.setFont('helvetica', 'bold');
    doc.text(pago.legajo || '-', 68, yPos, { align: 'right' });
    yPos += 4;
    
    doc.setFont('helvetica', 'normal');
    doc.text('DNI:', 12, yPos);
    doc.setFont('helvetica', 'bold');
    doc.text(String(pago.dni) || '-', 68, yPos, { align: 'right' });
    yPos += 6;
    
    // L√≠nea separadora
    doc.line(10, yPos, 70, yPos);
    yPos += 5;
    
    // Detalles del pago
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('DETALLES DEL PAGO', 40, yPos, { align: 'center' });
    yPos += 5;
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    doc.text('Concepto:', 12, yPos);
    doc.setFont('helvetica', 'bold');
    doc.text(pago.concepto || '-', 68, yPos, { align: 'right' });
    yPos += 4;
    
    if (pago.mes_cuota) {
      doc.setFont('helvetica', 'normal');
      doc.text('Cuota:', 12, yPos);
      doc.setFont('helvetica', 'bold');
      doc.text(pago.mes_cuota, 68, yPos, { align: 'right' });
      yPos += 4;
    }
    
    if (pago.periodo) {
      doc.setFont('helvetica', 'normal');
      doc.text('Per√≠odo:', 12, yPos);
      doc.setFont('helvetica', 'bold');
      doc.text(pago.periodo, 68, yPos, { align: 'right' });
      yPos += 4;
    }
    
    doc.setFont('helvetica', 'normal');
    doc.text('Medio de Pago:', 12, yPos);
    doc.setFont('helvetica', 'bold');
    doc.text(pago.medio_pago || '-', 68, yPos, { align: 'right' });
    yPos += 6;
    
    // Monto destacado
    doc.setFillColor(25, 118, 210);
    doc.rect(10, yPos, 60, 10, 'F');
    doc.setTextColor(255);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('TOTAL PAGADO', 15, yPos + 4);
    doc.setFontSize(12);
    doc.text(`$${parseFloat(pago.monto).toLocaleString('es-AR', {minimumFractionDigits: 2})}`, 65, yPos + 6.5, { align: 'right' });
    doc.setTextColor(0);
    yPos += 14;
    
    // Estado
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(76, 175, 80);
    doc.text(' PAGO CONFIRMADO', 40, yPos, { align: 'center' });
    doc.setTextColor(0);
    yPos += 7;
    
    // L√≠nea separadora
    doc.setDrawColor(200);
    doc.line(10, yPos, 70, yPos);
    yPos += 5;
    
    // Informaci√≥n adicional
    doc.setFontSize(7);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor(100);
    doc.text('Centro de ense√±anza de idiomas - CEMI', 40, yPos, { align: 'center' });
    yPos += 4;
    doc.text(`Comprobante generado el ${new Date().toLocaleDateString('es-ES')}`, 40, yPos, { align: 'center' });
    yPos += 3;
    doc.setFontSize(6);
    doc.text('Este documento es un comprobante v√°lido de pago', 40, yPos, { align: 'center' });
    
    // Descargar
    const nombreArchivo = `Comprobante_${String(pago.id_pago).padStart(6, '0')}_${pago.alumno.replace(/\s+/g, '_')}.pdf`;
    doc.save(nombreArchivo);
    
    Swal.fire({
      icon: 'success',
      title: 'Comprobante generado',
      text: 'Tu comprobante se ha descargado correctamente',
      timer: 2000,
      showConfirmButton: false
    });
  } catch (error) {
    console.error('Error al generar comprobante:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudo generar el comprobante'
    });
  }
}
</script>


</body>
</html>
