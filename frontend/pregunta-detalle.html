<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pregunta - Comunidad CEMI</title>
  <link rel="icon" type="image/png" href="images/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="assets/js/config.js"></script>
  <style>
    :root {
      --hw-charcoal: #1e1e1e;
      --hw-graphite: #656f77;
      --hw-light-gray: #8c939a;
      --hw-silver: #b8bdc2;
      --hw-off-white: #f8f9fa;
      --hw-cream: #f5f5f7;
      --hw-accent-orange: #f5a623;
      --hw-border: #dee2e6;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: var(--hw-off-white); 
      color: var(--hw-charcoal); 
      line-height: 1.6;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 15%;
      right: 8%;
      width: 300px;
      height: 300px;
      border: 1px solid rgba(101, 111, 119, 0.06);
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
    }

    .help-header { 
      background: var(--hw-charcoal); 
      position: sticky; 
      top: 0; 
      z-index: 100;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .header-top { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 16px 40px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .header-logo { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      text-decoration: none; 
      color: white; 
    }
    .header-logo img { 
      width: 36px; 
      height: 36px; 
      border-radius: 8px; 
      background: white; 
      padding: 3px; 
    }
    .header-logo span { 
      font-family: 'Georgia', serif;
      font-size: 17px; 
      font-weight: 400;
      letter-spacing: -0.3px;
    }
    .header-nav { display: flex; gap: 6px; }
    .header-nav a { 
      color: var(--hw-silver); 
      text-decoration: none; 
      padding: 8px 14px; 
      border-radius: 6px; 
      font-size: 13px; 
      font-weight: 500; 
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    .header-nav a:hover { 
      background: rgba(255,255,255,0.08); 
      color: white;
      border-color: rgba(255,255,255,0.1);
    }

    .main-content { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 40px 24px;
      position: relative;
      z-index: 1;
    }

    .back-link { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      color: var(--hw-graphite); 
      text-decoration: none; 
      font-size: 13px; 
      font-weight: 500; 
      margin-bottom: 28px; 
      transition: all 0.2s ease;
      padding: 6px 0;
    }
    .back-link:hover { color: var(--hw-charcoal); }
    .back-link i { width: 16px; height: 16px; }

    .question-card { 
      background: white; 
      border-radius: 12px; 
      padding: 32px; 
      border: 1px solid var(--hw-border);
      margin-bottom: 28px;
      position: relative;
    }
    .question-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--hw-charcoal) 0%, var(--hw-graphite) 100%);
      border-radius: 12px 12px 0 0;
    }
    
    .question-header { display: flex; gap: 14px; margin-bottom: 20px; }
    .author-avatar { 
      width: 44px; 
      height: 44px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 2px solid var(--hw-border);
    }
    .author-info { flex: 1; }
    .author-name { 
      font-size: 14px; 
      font-weight: 600; 
      color: var(--hw-charcoal);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .author-role { 
      display: inline-block; 
      font-size: 10px; 
      padding: 2px 8px; 
      background: var(--hw-cream);
      color: var(--hw-graphite); 
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border: 1px solid var(--hw-border);
    }
    .author-role.profesor {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      border-color: #fcd34d;
    }
    .author-role.admin {
      background: linear-gradient(135deg, var(--hw-charcoal) 0%, var(--hw-graphite) 100%);
      color: white;
      border-color: var(--hw-charcoal);
    }
    .question-date { 
      font-size: 12px; 
      color: var(--hw-light-gray); 
      margin-top: 2px; 
    }
    
    .question-badges { 
      margin-bottom: 18px; 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap; 
    }
    .badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 5px; 
      padding: 5px 12px; 
      border-radius: 6px; 
      font-size: 11px; 
      font-weight: 600;
      border: 1px solid var(--hw-border);
      background: var(--hw-cream);
      color: var(--hw-graphite);
    }
    .badge i { width: 12px; height: 12px; }
    .badge.category { 
      background: white;
    }
    .badge.resolved { 
      background: #ecfdf5; 
      color: #065f46;
      border-color: #a7f3d0;
    }
    .badge.closed { 
      background: #fef2f2; 
      color: #991b1b;
      border-color: #fecaca;
    }
    .badge.announcement { 
      background: var(--hw-charcoal); 
      color: white;
      border-color: var(--hw-charcoal);
    }
    .badge.featured { 
      background: #fffbeb;
      color: #92400e;
      border-color: #fcd34d;
    }

    .question-title { 
      font-size: 22px; 
      font-weight: 600; 
      color: var(--hw-charcoal); 
      margin-bottom: 16px; 
      line-height: 1.35;
      letter-spacing: -0.3px;
    }
    .question-content { 
      font-size: 14px; 
      color: var(--hw-graphite); 
      line-height: 1.75; 
      white-space: pre-wrap; 
    }

    .question-actions { 
      display: flex; 
      gap: 12px; 
      margin-top: 24px; 
      padding-top: 20px; 
      border-top: 1px solid var(--hw-border); 
    }
    .action-btn { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 10px 18px; 
      border: 1px solid var(--hw-border); 
      background: white; 
      border-radius: 8px; 
      font-size: 13px; 
      font-weight: 500;
      color: var(--hw-graphite); 
      cursor: pointer; 
      transition: all 0.2s ease; 
    }
    .action-btn:hover { 
      border-color: var(--hw-charcoal); 
      color: var(--hw-charcoal);
      background: var(--hw-cream);
    }
    .action-btn.voted { 
      background: var(--hw-charcoal); 
      color: white; 
      border-color: var(--hw-charcoal); 
    }
    .action-btn i { width: 16px; height: 16px; }

    .answers-section { margin-top: 36px; }
    .section-title { 
      font-size: 16px; 
      font-weight: 600; 
      color: var(--hw-charcoal); 
      margin-bottom: 20px; 
      display: flex; 
      align-items: center; 
      gap: 10px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--hw-border);
    }
    .section-title i { width: 20px; height: 20px; color: var(--hw-graphite); }

    .answer-card { 
      background: white; 
      border-radius: 10px; 
      padding: 24px; 
      border: 1px solid var(--hw-border); 
      margin-bottom: 14px;
      transition: all 0.2s ease;
    }
    .answer-card:hover {
      border-color: var(--hw-silver);
    }
    .answer-card.recommended { 
      border-left: 3px solid #059669; 
      background: linear-gradient(to right, rgba(5,150,105,0.02), white);
    }
    .recommended-badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 6px; 
      padding: 4px 10px; 
      background: #ecfdf5; 
      color: #065f46; 
      border-radius: 5px; 
      font-size: 11px; 
      font-weight: 600; 
      margin-bottom: 14px;
      border: 1px solid #a7f3d0;
    }
    .recommended-badge i { width: 13px; height: 13px; }

    .answer-header { display: flex; gap: 12px; margin-bottom: 14px; }
    .answer-avatar { 
      width: 36px; 
      height: 36px; 
      border-radius: 50%; 
      object-fit: cover;
      border: 1px solid var(--hw-border);
    }
    .answer-author-name { 
      font-size: 13px; 
      font-weight: 600; 
      color: var(--hw-charcoal); 
    }
    .answer-date { font-size: 11px; color: var(--hw-light-gray); }
    .answer-content { 
      font-size: 13px; 
      color: var(--hw-graphite); 
      line-height: 1.7; 
      white-space: pre-wrap; 
    }

    .answer-actions { 
      display: flex; 
      gap: 10px; 
      margin-top: 16px; 
      padding-top: 14px; 
      border-top: 1px solid var(--hw-cream); 
    }
    .answer-action { 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      padding: 6px 12px; 
      background: none; 
      border: 1px solid transparent;
      font-size: 12px; 
      color: var(--hw-light-gray); 
      cursor: pointer; 
      border-radius: 6px; 
      transition: all 0.2s ease; 
    }
    .answer-action:hover { 
      background: var(--hw-cream); 
      color: var(--hw-charcoal);
      border-color: var(--hw-border);
    }
    .answer-action.voted { 
      color: var(--hw-charcoal); 
      font-weight: 600;
      background: var(--hw-cream);
    }
    .answer-action i { width: 14px; height: 14px; }

    .reply-form { 
      background: white; 
      border-radius: 12px; 
      padding: 28px; 
      border: 1px solid var(--hw-border);
      margin-top: 28px; 
    }
    .reply-form h3 { 
      font-size: 15px; 
      font-weight: 600; 
      color: var(--hw-charcoal); 
      margin-bottom: 18px; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
    }
    .reply-form h3 i { width: 18px; height: 18px; color: var(--hw-graphite); }
    .reply-textarea { 
      width: 100%; 
      min-height: 120px; 
      padding: 16px; 
      border: 1px solid var(--hw-border); 
      border-radius: 10px; 
      font-size: 13px; 
      font-family: inherit; 
      resize: vertical; 
      transition: all 0.2s ease;
      background: var(--hw-off-white);
    }
    .reply-textarea:focus { 
      outline: none; 
      border-color: var(--hw-charcoal); 
      background: white;
      box-shadow: 0 0 0 3px rgba(30, 30, 30, 0.06); 
    }
    .reply-actions { display: flex; justify-content: flex-end; margin-top: 16px; }
    .btn { 
      padding: 11px 22px; 
      border-radius: 8px; 
      font-size: 13px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.2s ease; 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      border: none; 
    }
    .btn-primary { 
      background: var(--hw-charcoal); 
      color: white; 
    }
    .btn-primary:hover { 
      background: #2d2d2d;
      transform: translateY(-1px); 
      box-shadow: 0 4px 12px rgba(30, 30, 30, 0.2); 
    }
    .btn:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
      transform: none !important; 
    }

    .login-prompt { 
      background: var(--hw-cream);
      border: 1px solid var(--hw-border); 
      border-radius: 10px; 
      padding: 28px; 
      text-align: center; 
    }
    .login-prompt p { 
      color: var(--hw-graphite); 
      margin-bottom: 14px;
      font-size: 14px;
    }
    .login-prompt a { 
      color: var(--hw-charcoal); 
      font-weight: 600; 
      text-decoration: none;
      padding: 8px 20px;
      background: white;
      border: 1px solid var(--hw-border);
      border-radius: 6px;
      display: inline-block;
      transition: all 0.2s ease;
    }
    .login-prompt a:hover {
      background: var(--hw-charcoal);
      color: white;
      border-color: var(--hw-charcoal);
    }

    .empty-answers { 
      text-align: center; 
      padding: 48px 24px; 
      color: var(--hw-light-gray);
      background: var(--hw-cream);
      border-radius: 10px;
      border: 1px dashed var(--hw-border);
    }
    .empty-answers i { 
      width: 40px; 
      height: 40px; 
      color: var(--hw-silver); 
      margin-bottom: 14px; 
    }
    .empty-answers h4 { 
      color: var(--hw-charcoal); 
      margin-bottom: 6px;
      font-size: 15px;
      font-weight: 600;
    }
    .empty-answers p {
      font-size: 13px;
    }

    .loading { 
      text-align: center; 
      padding: 70px; 
      color: var(--hw-light-gray); 
    }
    .loading i { 
      animation: spin 1s linear infinite; 
      width: 28px; 
      height: 28px;
      color: var(--hw-graphite);
    }
    .loading p {
      margin-top: 12px;
      font-size: 13px;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .error-state { 
      text-align: center; 
      padding: 70px;
      background: white;
      border-radius: 12px;
      border: 1px solid var(--hw-border);
    }
    .error-state i { 
      width: 52px; 
      height: 52px; 
      color: #f87171; 
      margin-bottom: 18px; 
    }
    .error-state h3 { 
      color: #991b1b; 
      margin-bottom: 8px;
      font-size: 18px;
    }
    .error-state p { 
      color: var(--hw-graphite); 
      margin-bottom: 24px;
      font-size: 14px;
    }

    /* Footer */
    .help-footer {
      background: var(--hw-charcoal);
      margin-top: 60px;
      padding: 32px 40px;
    }
    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .footer-links {
      display: flex;
      gap: 24px;
    }
    .footer-links a {
      color: var(--hw-silver);
      text-decoration: none;
      font-size: 13px;
      transition: color 0.2s ease;
    }
    .footer-links a:hover {
      color: white;
    }
    .footer-copy {
      color: var(--hw-graphite);
      font-size: 12px;
    }

    @media (max-width: 768px) {
      .header-top { padding: 12px 20px; }
      .header-nav { display: none; }
      .main-content { padding: 24px 16px; }
      .question-card { padding: 24px 20px; }
      .question-title { font-size: 18px; }
      .answer-card { padding: 20px; }
      .reply-form { padding: 20px; }
      .help-footer { padding: 24px 20px; }
      .footer-content { flex-direction: column; gap: 16px; text-align: center; }
    }
  </style>
</head>
<body>
  <header class="help-header">
    <div class="header-top">
      <a href="classroom.html" class="header-logo">
        <img src="images/logo.png" alt="CEMI">
        <span>Comunidad CEMI</span>
      </a>
      <nav class="header-nav">
        <a href="ayuda-classroom.html">Centro de Ayuda</a>
        <a href="comunidad-ayuda.html">Comunidad</a>
        <a href="novedades-cemi.html">Novedades</a>
        <a href="classroom.html">Volver a Classroom</a>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <a href="comunidad-ayuda.html" class="back-link"><i data-lucide="arrow-left"></i>Volver a la comunidad</a>
    
    <div id="contentContainer">
      <div class="loading"><i data-lucide="loader"></i><p>Cargando pregunta...</p></div>
    </div>
  </main>

  <script>
    let currentUser = null;
    let pregunta = null;
    let respuestas = [];
    const preguntaId = new URLSearchParams(window.location.search).get('id');

    function checkSession() {
      // Leer datos de sesión del localStorage (formato usado por classroom-login.js)
      const nombre = localStorage.getItem('nombre');
      const rol = localStorage.getItem('rol');
      const avatar = localStorage.getItem('avatar');
      const idProfesor = localStorage.getItem('id_profesor');
      const idAlumno = localStorage.getItem('id_alumno');
      const idUsuario = localStorage.getItem('id_usuario');

      if (nombre && rol) {
        let tipo = 'alumno';
        let id = idAlumno || idUsuario;
        let rolDisplay = 'Alumno';

        if (rol === 'profesor' || idProfesor) {
          tipo = 'profesor';
          id = idProfesor || idUsuario;
          rolDisplay = 'Profesor';
        } else if (rol === 'admin' || rol === 'administrador') {
          tipo = 'admin';
          id = idUsuario;
          rolDisplay = 'Administrador';
        }

        currentUser = { tipo, id, nombre, avatar, rol: rolDisplay };
      }
    }

    async function loadPregunta() {
      if (!preguntaId) {
        showError('No se especifico una pregunta');
        return;
      }

      try {
        const response = await fetchWithAuth(`/api/comunidad/preguntas/${preguntaId}`);
        const data = await response.json();

        if (data.success) {
          pregunta = data.pregunta;
          respuestas = data.respuestas || [];
          document.title = `${pregunta.titulo} - Comunidad CEMI`;
          renderContent();
        } else {
          showError(data.error || 'Pregunta no encontrada');
        }
      } catch (error) {
        console.error('Error:', error);
        showError('Error al cargar la pregunta');
      }
    }

    function showError(message) {
      document.getElementById('contentContainer').innerHTML = `
        <div class="error-state">
          <i data-lucide="alert-circle"></i>
          <h3>Error</h3>
          <p>${message}</p>
          <a href="comunidad-ayuda.html" class="btn btn-primary">Volver a la comunidad</a>
        </div>
      `;
      lucide.createIcons();
    }

    function renderContent() {
      const fecha = new Date(pregunta.fechaCreacion).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      const votanteKey = currentUser ? `${currentUser.tipo}_${currentUser.id}` : null;
      const hasVoted = votanteKey && pregunta.votantes && pregunta.votantes.includes(votanteKey);

      const avatarUrl = pregunta.autorAvatar 
        ? (pregunta.autorAvatar.startsWith('http') ? pregunta.autorAvatar : `/uploads/avatars/${pregunta.autorAvatar}`)
        : `https://ui-avatars.com/api/?name=${encodeURIComponent(pregunta.autorNombre)}&background=1e1e1e&color=fff`;

      let badges = '';
      const categoryNames = {
        'primeros-pasos': 'Primeros Pasos',
        'tareas': 'Tareas y Entregas',
        'comunicacion': 'Comunicacion',
        'recursos': 'Recursos',
        'cuenta': 'Mi Cuenta',
        'otro': 'Otro'
      };
      badges += `<span class="badge category"><i data-lucide="tag"></i>${categoryNames[pregunta.categoria] || pregunta.categoria}</span>`;
      if (pregunta.esAnuncio) badges += '<span class="badge announcement"><i data-lucide="megaphone"></i>Anuncio</span>';
      if (pregunta.destacado) badges += '<span class="badge featured"><i data-lucide="pin"></i>Destacado</span>';
      if (pregunta.estado === 'resuelta') badges += '<span class="badge resolved"><i data-lucide="check-circle"></i>Resuelta</span>';
      if (pregunta.estado === 'cerrada') badges += '<span class="badge closed"><i data-lucide="lock"></i>Cerrada</span>';

      const authorRole = pregunta.autorTipo === 'profesor' ? '<span class="author-role profesor">Profesor</span>' : 
                         pregunta.autorTipo === 'admin' ? '<span class="author-role admin">Admin</span>' : '';

      let html = `
        <div class="question-card">
          <div class="question-header">
            <img src="${avatarUrl}" alt="" class="author-avatar">
            <div class="author-info">
              <div class="author-name">${escapeHtml(pregunta.autorNombre)}${authorRole}</div>
              <div class="question-date">${fecha}</div>
            </div>
          </div>
          <div class="question-badges">${badges}</div>
          <h1 class="question-title">${escapeHtml(pregunta.titulo)}</h1>
          <div class="question-content">${escapeHtml(pregunta.descripcion)}</div>
          <div class="question-actions">
            <button class="action-btn ${hasVoted ? 'voted' : ''}" onclick="votarPregunta()">
              <i data-lucide="thumbs-up"></i>
              <span id="voteCount">${pregunta.votos}</span> votos
            </button>
          </div>
        </div>

        <div class="answers-section">
          <h2 class="section-title"><i data-lucide="message-circle"></i>Respuestas (${respuestas.length})</h2>
          ${renderRespuestas()}
        </div>

        ${renderReplyForm()}
      `;

      document.getElementById('contentContainer').innerHTML = html;
      lucide.createIcons();
    }

    function renderRespuestas() {
      if (respuestas.length === 0) {
        return `
          <div class="empty-answers">
            <i data-lucide="message-circle"></i>
            <h4>Aun no hay respuestas</h4>
            <p>Se el primero en responder a esta pregunta</p>
          </div>
        `;
      }

      return respuestas.map(r => {
        const fecha = new Date(r.fechaCreacion).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        const votanteKey = currentUser ? `${currentUser.tipo}_${currentUser.id}` : null;
        const hasVoted = votanteKey && r.votantes && r.votantes.includes(votanteKey);
        
        const avatarUrl = r.autorAvatar 
          ? (r.autorAvatar.startsWith('http') ? r.autorAvatar : `/uploads/avatars/${r.autorAvatar}`)
          : `https://ui-avatars.com/api/?name=${encodeURIComponent(r.autorNombre)}&background=1e1e1e&color=fff`;

        const roleClass = r.autorTipo === 'profesor' ? 'profesor' : r.autorTipo === 'admin' ? 'admin' : '';
        const authorRole = r.autorRol ? `<span class="author-role ${roleClass}">${r.autorRol}</span>` : '';

        return `
          <div class="answer-card ${r.esRecomendada ? 'recommended' : ''}" data-id="${r.id}">
            ${r.esRecomendada ? '<div class="recommended-badge"><i data-lucide="award"></i>Respuesta recomendada</div>' : ''}
            <div class="answer-header">
              <img src="${avatarUrl}" alt="" class="answer-avatar">
              <div>
                <div class="answer-author-name">${escapeHtml(r.autorNombre)}${authorRole}</div>
                <div class="answer-date">${fecha}</div>
              </div>
            </div>
            <div class="answer-content">${escapeHtml(r.contenido)}</div>
            <div class="answer-actions">
              <button class="answer-action ${hasVoted ? 'voted' : ''}" onclick="votarRespuesta('${r.id}')">
                <i data-lucide="thumbs-up"></i>
                <span id="respVotes-${r.id}">${r.votos}</span> votos
              </button>
              ${(currentUser && (currentUser.tipo === 'profesor' || currentUser.tipo === 'admin')) ? `
                <button class="answer-action" onclick="toggleRecomendar('${r.id}', ${!r.esRecomendada})">
                  <i data-lucide="${r.esRecomendada ? 'x' : 'award'}"></i>
                  ${r.esRecomendada ? 'Quitar recomendacion' : 'Recomendar'}
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderReplyForm() {
      if (pregunta.estado === 'cerrada') {
        return `
          <div class="login-prompt">
            <i data-lucide="lock" style="width: 32px; height: 32px; color: #94a3b8; margin-bottom: 12px;"></i>
            <p>Esta pregunta esta cerrada y no acepta mas respuestas.</p>
          </div>
        `;
      }

      if (!currentUser) {
        return `
          <div class="login-prompt">
            <p>Inicia sesion para responder a esta pregunta</p>
            <a href="login-selector.html">Iniciar sesion</a>
          </div>
        `;
      }

      return `
        <div class="reply-form">
          <h3><i data-lucide="edit-3"></i>Tu respuesta</h3>
          <textarea class="reply-textarea" id="replyContent" placeholder="Escribe tu respuesta aqui..." maxlength="5000"></textarea>
          <div class="reply-actions">
            <button class="btn btn-primary" onclick="submitReply()" id="submitReplyBtn">
              <i data-lucide="send"></i>Publicar respuesta
            </button>
          </div>
        </div>
      `;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function votarPregunta() {
      if (!currentUser) { alert('Debes iniciar sesion para votar'); return; }
      try {
        const response = await fetchWithAuth(`/api/comunidad/preguntas/${preguntaId}/votar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ votanteTipo: currentUser.tipo, votanteId: currentUser.id })
        });
        const data = await response.json();
        if (data.success) {
          pregunta.votos = data.votos;
          const votanteKey = `${currentUser.tipo}_${currentUser.id}`;
          if (data.action === 'added') {
            if (!pregunta.votantes) pregunta.votantes = [];
            pregunta.votantes.push(votanteKey);
          } else {
            pregunta.votantes = pregunta.votantes.filter(v => v !== votanteKey);
          }
          document.getElementById('voteCount').textContent = data.votos;
          const btn = document.querySelector('.action-btn');
          btn.classList.toggle('voted', data.action === 'added');
        }
      } catch (error) { console.error('Error:', error); }
    }

    async function votarRespuesta(respuestaId) {
      if (!currentUser) { alert('Debes iniciar sesion para votar'); return; }
      try {
        const response = await fetchWithAuth(`/api/comunidad/preguntas/${preguntaId}/respuestas/${respuestaId}/votar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ votanteTipo: currentUser.tipo, votanteId: currentUser.id })
        });
        const data = await response.json();
        if (data.success) {
          const resp = respuestas.find(r => r.id === respuestaId);
          if (resp) {
            resp.votos = data.votos;
            const votanteKey = `${currentUser.tipo}_${currentUser.id}`;
            if (data.action === 'added') {
              if (!resp.votantes) resp.votantes = [];
              resp.votantes.push(votanteKey);
            } else {
              resp.votantes = resp.votantes.filter(v => v !== votanteKey);
            }
          }
          document.getElementById(`respVotes-${respuestaId}`).textContent = data.votos;
          const btn = document.querySelector(`[data-id="${respuestaId}"] .answer-action`);
          if (btn) btn.classList.toggle('voted', data.action === 'added');
        }
      } catch (error) { console.error('Error:', error); }
    }

    async function toggleRecomendar(respuestaId, recomendar) {
      try {
        const response = await fetchWithAuth(`/api/comunidad/preguntas/${preguntaId}/respuestas/${respuestaId}/recomendar`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recomendar })
        });
        const data = await response.json();
        if (data.success) {
          const resp = respuestas.find(r => r.id === respuestaId);
          if (resp) resp.esRecomendada = recomendar;
          renderContent();
        }
      } catch (error) { console.error('Error:', error); }
    }

    async function submitReply() {
      const content = document.getElementById('replyContent').value.trim();
      if (!content) { alert('Escribe tu respuesta'); return; }

      const btn = document.getElementById('submitReplyBtn');
      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader"></i>Publicando...';
      lucide.createIcons();

      try {
        const response = await fetchWithAuth(`/api/comunidad/preguntas/${preguntaId}/respuestas`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contenido: content,
            autorTipo: currentUser.tipo,
            autorId: currentUser.id,
            autorNombre: currentUser.nombre,
            autorAvatar: currentUser.avatar
          })
        });
        const data = await response.json();
        if (data.success) {
          respuestas.push(data.respuesta);
          document.getElementById('replyContent').value = '';
          renderContent();
        } else {
          alert(data.error || 'Error al publicar respuesta');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al publicar respuesta');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="send"></i>Publicar respuesta';
        lucide.createIcons();
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      lucide.createIcons();
      checkSession();
      loadPregunta();
    });
  </script>

  <footer class="help-footer">
    <div class="footer-content">
      <div class="footer-links">
        <a href="ayuda-classroom.html">Centro de Ayuda</a>
        <a href="privacidad.html">Privacidad</a>
        <a href="terminos.html">Términos</a>
      </div>
      <div class="footer-copy">© 2025 CEMI - Centro Educativo Multilingüe Integral</div>
    </div>
  </footer>
</body>
</html>



