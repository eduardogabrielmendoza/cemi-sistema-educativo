<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acceso con Clave - Cemi</title>
  <link rel="icon" type="image/png" href="images/logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/login-key.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="assets/js/config.js"></script>
</head>
<body class="login-key-body">
  <header class="login-key-header">
    <div class="header-content">
      <i data-lucide="settings" class="header-icon"></i>
      <span>Inicia sesion con tu cuenta para acceder a CemiKey</span>
    </div>
  </header>

  <main class="login-key-main">
    <div class="login-key-card">
      <div class="card-logo">
        <img src="images/logo.png" alt="Cemi Logo" class="logo-img">
        <div class="logo-text">
          <span class="logo-cemi">CEMI</span><span class="logo-key">KEY</span>
        </div>
      </div>

      <div class="card-divider"></div>

      <form id="loginKeyForm" class="login-key-form">
        <h2 class="form-title">Ingresar</h2>

        <div class="form-group">
          <label for="accessKey" class="form-label">Clave de acceso</label>
          <input 
            type="password" 
            id="accessKey" 
            name="accessKey" 
            class="form-input" 
            placeholder=""
            required 
            autocomplete="off"
          >
        </div>

        <button type="submit" class="submit-btn">
          Ingresar
        </button>

        <div class="form-links">
          <a href="login-admin.html" class="form-link">Volver al login tradicional</a>
        </div>

        <div class="form-links">
          <a href="#" class="form-link" onclick="showHelp(event)">Ayuda <i data-lucide="external-link" class="link-icon"></i></a>
        </div>
      </form>

      <p id="loginMessage" class="login-message"></p>
    </div>
  </main>

  <footer class="login-key-footer">
    <a href="privacidad.html" class="footer-link">Politica de Privacidad</a>
  </footer>

  <div class="loader-overlay" id="loader">
    <div class="loader-spinner">
      <div class="spinner-circle"></div>
      <div class="spinner-circle"></div>
      <div class="spinner-circle"></div>
    </div>
    <p class="loader-text">Verificando clave de acceso...</p>
  </div>

  <script>
    lucide.createIcons();

    function showHelp(e) {
      e.preventDefault();
      Swal.fire({
        title: 'Ayuda - Clave de Acceso',
        html: `
          <div style="text-align: left;">
            <p><strong>Acerca de CemiKey</strong></p>
            <p style="margin-top: 10px; color: #555;">La clave de acceso es un metodo alternativo de autenticacion exclusivo para administradores.</p>
            <ul style="margin-top: 10px; color: #555;">
              <li>Esta clave es proporcionada por un administrador del sistema</li>
              <li>Si no tienes una clave, usa el login tradicional</li>
              <li>Para solicitar una clave, contacta al administrador principal</li>
            </ul>
            <p style="margin-top: 15px;"><strong>Contacto:</strong></p>
            <p style="color: #555;">Email: admin@cemiedu.ar</p>
          </div>
        `,
        icon: 'info',
        confirmButtonColor: '#1e1e1e'
      });
    }

    document.getElementById('loginKeyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const accessKey = document.getElementById('accessKey').value.trim();
      const messageEl = document.getElementById('loginMessage');
      const loader = document.getElementById('loader');
      
      if (!accessKey) {
        messageEl.textContent = 'Por favor, ingrese su clave de acceso';
        messageEl.className = 'login-message error';
        return;
      }
      
      if (loader) {
        loader.classList.add('show');
      }
      messageEl.textContent = '';
      
      try {
        const startTime = Date.now();
        const response = await fetch(`${API_URL}/auth/login-key`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accessKey })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          if (data.token) {
            localStorage.setItem('token', data.token);
          }
          localStorage.setItem('rol', data.rol);
          localStorage.setItem('id_usuario', data.id_usuario);
          localStorage.setItem('nombre', data.nombre);
          localStorage.setItem('username', data.username);
          if (data.id_administrador) {
            localStorage.setItem('id_administrador', data.id_administrador);
          }
          
          messageEl.textContent = 'Acceso exitoso. Redirigiendo...';
          messageEl.className = 'login-message success';
          
          const elapsedTime = Date.now() - startTime;
          const minDelay = 1500;
          const remainingDelay = Math.max(0, minDelay - elapsedTime);
          
          await new Promise(resolve => setTimeout(resolve, remainingDelay));
          
          window.location.href = 'dashboard_admin.html';
        } else {
          if (loader) {
            loader.classList.remove('show');
          }
          messageEl.textContent = data.message || 'Clave de acceso invalida';
          messageEl.className = 'login-message error';
        }
      } catch (error) {
        console.error('Error:', error);
        if (loader) {
          loader.classList.remove('show');
        }
        messageEl.textContent = 'Error de conexion. Intente nuevamente.';
        messageEl.className = 'login-message error';
      }
    });
  </script>
</body>
</html>
